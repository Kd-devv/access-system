<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Log i Aksesimeve - me Filtra, Faqetim & Eksport CSV</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .controls {
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;
      align-items: center;
    }
    .controls > * {
      flex: 1 1 150px;
      min-width: 120px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .btn {
      padding: 8px 16px; font-size: 14px; cursor: pointer;
      border: none; background-color: #007bff; color: white;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    .btn:hover { background-color: #0056b3; }
    .pagination {
      margin-top: 15px;
      text-align: center;
      user-select: none;
    }
    .pagination button {
      margin: 0 5px;
    }
  </style>
</head>
<body>

  <h1>ðŸ“‹ Log i Aksesimeve</h1>

  <div class="controls">
    <div>
      <label for="searchName">Kerko Emrin:</label>
      <input id="searchName" type="text" placeholder="Shkruaj emrin..."/>
    </div>
    <div>
      <label for="statusFilter">Filtro Statusin:</label>
      <select id="statusFilter">
        <option value="">TÃ« gjithÃ«</option>
        <option value="success">Sukses</option>
        <option value="wrong_pin">PIN gabim</option>
        <option value="user_not_found">PÃ«rdoruesi nuk ekziston</option>
        <option value="out_of_hours">JashtÃ« orarit</option>
        <option value="ifttt_failed">IFTTT dÃ«shtoi</option>
        <option value="network_error">Gabim rrjeti</option>
      </select>
    </div>
    <div>
      <label for="dateFrom">Data Nga:</label>
      <input id="dateFrom" type="date"/>
    </div>
    <div>
      <label for="dateTo">Data Deri:</label>
      <input id="dateTo" type="date"/>
    </div>

    <div style="align-self:flex-end;">
      <button class="btn" id="btnReload">ðŸ”„ Rifresko</button>
    </div>

    <div style="align-self:flex-end;">
      <button class="btn" id="btnFilter">Filtro</button>
    </div>
    <div style="align-self:flex-end;">
      <button class="btn" id="btnExport">Eksporto CSV</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Emri</th>
        <th>PIN</th>
        <th>Data & Ora</th>
        <th>IP</th>
        <th>Statusi</th>
      </tr>
    </thead>
    <tbody id="logTable">
      <tr><td colspan="5">Ngarkohet...</td></tr>
    </tbody>
  </table>

  <div class="pagination">
    <button id="prevPage" class="btn" disabled>âŸ¨ Paraprak</button>
    <span id="pageInfo"></span>
    <button id="nextPage" class="btn" disabled>PasardhÃ«s âŸ©</button>
  </div>

  <script>
    const logsUrl = "https://porta.armnis76.workers.dev/logs";
    const usersUrl = "https://porta.armnis76.workers.dev";

    let allLogs = [];
    let allUsers = {};
    let filteredLogs = [];

    const pageSize = 15;
    let currentPage = 1;

    const logTableBody = document.getElementById("logTable");
    const searchNameInput = document.getElementById("searchName");
    const statusFilterSelect = document.getElementById("statusFilter");
    const dateFromInput = document.getElementById("dateFrom");
    const dateToInput = document.getElementById("dateTo");
    const btnFilter = document.getElementById("btnFilter");
    const btnExport = document.getElementById("btnExport");
    const btnReload = document.getElementById("btnReload");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfoSpan = document.getElementById("pageInfo");

    async function fetchData() {
      try {
        logTableBody.innerHTML = '<tr><td colspan="5">Ngarkohet...</td></tr>';
        const [logsRes, usersRes] = await Promise.all([
          fetch(logsUrl),
          fetch(usersUrl)
        ]);
        if (!logsRes.ok) throw new Error("Nuk mund tÃ« merret lista e logeve");
        if (!usersRes.ok) throw new Error("Nuk mund tÃ« merret lista e pÃ«rdoruesve");

        const logsData = await logsRes.json();
        allLogs = Object.values(logsData).map(log => ({
          ...log,
          timeDate: new Date(log.time)
        }));

        allUsers = await usersRes.json();

        filteredLogs = allLogs.slice();

        currentPage = 1;
        renderTable();
      } catch (err) {
        logTableBody.innerHTML = `<tr><td colspan="5" style="color:red">${err.message}</td></tr>`;
      }
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageItems = filteredLogs.slice(start, end);

      if (pageItems.length === 0) {
        logTableBody.innerHTML = `<tr><td colspan="5">AsnjÃ« log i gjetur.</td></tr>`;
        pageInfoSpan.textContent = "";
      } else {
        logTableBody.innerHTML = pageItems.map(log => {
          const pin = allUsers[log.user]?.pin || "â€”";
          return `<tr>
            <td>${log.user}</td>
            <td>${pin}</td>
            <td>${log.timeDate.toLocaleString()}</td>
            <td>${log.ip}</td>
            <td>${log.status}</td>
          </tr>`;
        }).join("");
        pageInfoSpan.textContent = `Faqja ${currentPage} nga ${Math.ceil(filteredLogs.length / pageSize)}`;
      }

      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage * pageSize >= filteredLogs.length;
    }

    function applyFilters() {
      const searchName = searchNameInput.value.trim().toLowerCase();
      const statusFilter = statusFilterSelect.value;
      const dateFrom = dateFromInput.value ? new Date(dateFromInput.value) : null;
      const dateTo = dateToInput.value ? new Date(dateToInput.value) : null;

      filteredLogs = allLogs.filter(log => {
        if (searchName && !log.user.toLowerCase().includes(searchName)) return false;
        if (statusFilter && log.status !== statusFilter) return false;
        if (dateFrom && log.timeDate < dateFrom) return false;
        if (dateTo) {
          // include whole day by adding 1 day and checking less than next day
          const nextDay = new Date(dateTo);
          nextDay.setDate(nextDay.getDate() + 1);
          if (log.timeDate >= nextDay) return false;
        }
        return true;
      });
      currentPage = 1;
      renderTable();
    }

    function exportCSV() {
      if (filteredLogs.length === 0) {
        alert("AsnjÃ« tÃ« dhÃ«nÃ« pÃ«r eksport.");
        return;
      }
      let csv = "Emri,PIN,Data & Ora,IP,Status\n";
      for (const log of filteredLogs) {
        const pin = allUsers[log.user]?.pin || "";
        const row = [
          `"${log.user}"`,
          `"${pin}"`,
          `"${log.timeDate.toISOString()}"`,
          `"${log.ip}"`,
          `"${log.status}"`
        ].join(",");
        csv += row + "\n";
      }
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `logs_export_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    btnFilter.addEventListener("click", applyFilters);
    btnExport.addEventListener("click", exportCSV);
    btnReload.addEventListener("click", fetchData);

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPage * pageSize < filteredLogs.length) {
        currentPage++;
        renderTable();
      }
    });

    fetchData();
  </script>
</body>
</html>

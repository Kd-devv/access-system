<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit tÃ« Aksesit</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    input, button, select { padding: 8px; margin: 4px 0; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>ðŸšª Sistemi i Kontrollit tÃ« Aksesit (Admin Panel)</h1>
  
  <h2>Menaxhimi i PÃ«rdoruesve</h2>
  <!-- Forma ekzistuese pÃ«r menaxhimin e pÃ«rdoruesve -->
  
  <h2>Gjenero Kod Aksesi</h2>
  <div>
    <input id="genUsername" placeholder="Emri i pÃ«rdoruesit">
    <input id="genAdminPass" type="password" placeholder="FjalÃ«kalimi admin">
    <button onclick="generateAccessCode()">Gjenero Kod tÃ« Ri</button>
    <div id="genResult" class="msg"></div>
  </div>
  
  <h2>Kodet Aktive</h2>
  <table id="codesTable">
    <thead>
      <tr>
        <th>Kodi</th>
        <th>PÃ«rdoruesi</th>
        <th>Data e Krijimit</th>
        <th>URL pÃ«r QR Kod</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    
    async function generateAccessCode() {
      const username = document.getElementById("genUsername").value.trim();
      const adminPass = document.getElementById("genAdminPass").value;
      const resultDiv = document.getElementById("genResult");
      
      if (!username || !adminPass) {
        resultDiv.textContent = "Ju lutem plotÃ«soni tÃ« gjitha fushat";
        resultDiv.className = "msg error";
        return;
      }
      
      try {
        const res = await fetch(`${apiUrl}/generate-code`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, adminPass })
        });
        
        const data = await res.json();
        if (res.ok) {
          resultDiv.innerHTML = `
            <strong>Kodi i ri:</strong> ${data.code}<br>
            <strong>URL pÃ«r QR Kod:</strong> ${apiUrl}/open/${data.code}
          `;
          resultDiv.className = "msg success";
          loadActiveCodes();
        } else {
          resultDiv.textContent = data.error || "Gabim i panjohur";
          resultDiv.className = "msg error";
        }
      } catch (err) {
        resultDiv.textContent = "Gabim nÃ« rrjet: " + err.message;
        resultDiv.className = "msg error";
      }
    }
    
    async function loadActiveCodes() {
      // Implementimi aktual varet nga struktura e tÃ« dhÃ«nave nÃ« KV
      // Ky Ã«shtÃ« njÃ« shembull bazÃ«
      const tbody = document.querySelector("#codesTable tbody");
      tbody.innerHTML = "<tr><td colspan='4'>Po ngarkohen...</td></tr>";
      
      try {
        const res = await fetch(`${apiUrl}/list-codes`);
        const codes = await res.json();
        
        tbody.innerHTML = "";
        for (const [code, data] of Object.entries(codes)) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${code.replace('access-code-', '')}</td>
            <td>${data.username}</td>
            <td>${new Date(data.createdAt).toLocaleString()}</td>
            <td>${apiUrl}/open/${code.replace('access-code-', '')}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan='4'>Gabim nÃ« ngarkim: ${err.message}</td></tr>`;
      }
    }
    
    // Ngarko kodet kur faqja hapet
    window.onload = loadActiveCodes;
  </script>
</body>
</html>

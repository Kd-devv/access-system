<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit të Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* STILIZIMET ORIGJINALE */
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    #password-protection { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    #password-form { background: white; padding: 30px; border-radius: 8px; text-align: center; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ccc; }
    .tab { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; }
    .tab.active { background: white; border-bottom: 1px solid white; margin-bottom: -1px; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .time-slots { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .time-slot { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .remove-btn { background: #ff6b6b; color: white; border: none; padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje në Sistem</h2>
      <input type="password" id="access-password" placeholder="Fjalëkalimi" />
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error" style="color: red; display: none;"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="protected-content" style="display: none;">
    <h1>🚪 Sistemi i Kontrollit të Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Menaxhimi i Përdoruesve</div>
      <div class="tab" onclick="switchTab('logs')">Logjet e Aksesit</div>
    </div>
    
    <!-- User Management Tab -->
    <div id="users-tab" class="tab-content active">
      <div class="form-group">
        <label for="name">Emri i përdoruesit:</label>
        <input id="name" placeholder="Emri">
      </div>
      <div class="form-group">
        <label for="pin">PIN:</label>
        <input id="pin" placeholder="PIN" type="password">
      </div>
      <div class="form-group">
        <label for="adminPass">Fjalëkalimi Admin:</label>
        <input id="adminPass" placeholder="Fjalëkalimi admin" type="password">
      </div>
      <div class="time-slots">
        <h3>Intervalet kohore të lejuara:</h3>
        <div id="timeSlotsContainer"></div>
        <button class="add-btn" onclick="addTimeSlot()">+ Shto Interval Kohor</button>
      </div>
      <button onclick="addUser()">Shto Përdorues</button>
      <div class="msg" id="msg"></div>
      <table id="userTable">
        <thead>
          <tr>
            <th>Emri</th>
            <th>PIN</th>
            <th>Intervalet Kohore</th>
            <th>Veprim</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Access Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="controls">
        <input type="text" id="filterInput" placeholder="Filtro sipas emrit, IP, statusit...">
        <button onclick="loadLogs()">🔁 Rifresko</button>
        <button onclick="exportAllXLSX()">📤 Eksporto të gjitha</button>
        <button onclick="exportFilteredXLSX()">📤 Eksporto të filtruarat</button>
        <button onclick="deleteFilteredLogs()" style="background-color: #f44336;">🗑️ Fshij të filtruarat</button>
        <button onclick="deleteAllLogs()" style="background-color: #f44336;">🗑️ Fshij të gjitha</button>
      </div>
      <table id="logTable">
        <thead>
          <tr>
            <th>Koha</th>
            <th>Emri</th>
            <th>PIN</th>
            <th>IP</th>
            <th>Statusi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Variablat globale
    const apiUrl = "https://porta.armnis76.workers.dev";
    let authToken = null;
    let allLogs = [];

    // Funksionet e autentifikimit (ruajini të njëjtat)
    async function checkPassword() {
      const password = document.getElementById("access-password").value;
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });
        const data = await response.json();
        if (response.ok && data.token) {
          authToken = data.token;
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          sessionStorage.setItem("authToken", data.token);
          fetchUsers();
        } else {
          showError("Fjalëkalimi i gabuar");
        }
      } catch (err) {
        showError("Gabim në rrjet");
      }
    }

    // Funksionet e menaxhimit të përdoruesve (ruajini të njëjtat)
    function addTimeSlot() {
      const container = document.getElementById("timeSlotsContainer");
      const slotDiv = document.createElement("div");
      slotDiv.className = "time-slot";
      slotDiv.innerHTML = `
        <input type="text" class="time-start" placeholder="Fillimi">
        <span>deri</span>
        <input type="text" class="time-end" placeholder="Mbarimi">
        <button class="remove-btn" onclick="this.parentElement.remove()">Fshij</button>
      `;
      flatpickr(slotDiv.querySelector(".time-start"), { enableTime: true, dateFormat: "Y-m-d H:i" });
      flatpickr(slotDiv.querySelector(".time-end"), { enableTime: true, dateFormat: "Y-m-d H:i" });
      container.appendChild(slotDiv);
    }

    async function addUser() {
      // Implementimi origjinal i funksionit
    }

    // Funksionet e logjeve (ruajini të njëjtat)
    async function loadLogs() {
      try {
        const response = await fetch(`${apiUrl}/logs`, {
          headers: { "Authorization": `Bearer ${authToken}` }
        });
        const data = await response.json();
        allLogs = Object.values(data);
        renderLogs();
      } catch (err) {
        console.error("Gabim në ngarkimin e logjeve:", err);
      }
    }

    function renderLogs() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";

      allLogs.filter(log => {
        const values = [log.user, log.pin, log.ip, log.status].map(v => (v || "").toLowerCase());
        return !filter || values.some(v => v.includes(filter));
      }).forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(log.time).toLocaleString()}</td>
          <td>${log.user || "-"}</td>
          <td>${log.pin || "-"}</td>
          <td>${log.ip || "-"}</td>
          <td>${log.status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Funksionet ndihmëse (ruajini të njëjtat)
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      if (tabName === 'logs') loadLogs();
    }

    function showError(message) {
      const errorElement = document.getElementById("password-error");
      errorElement.textContent = message;
      errorElement.style.display = "block";
    }

    // Initialize
    document.getElementById("access-password").addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkPassword();
    });

    if (sessionStorage.getItem("authToken")) {
      checkPassword();
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Menaxhimi i PÃ«rdoruesve</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    input, button, select { padding: 8px; margin: 4px 0; width: 100%; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .schedule-container { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .schedule-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .schedule-item input { width: auto; }
    .time-input { width: 60px !important; }
    .remove-btn { background: #ff6b6b; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .add-btn { background: #4CAF50; color: white; border: none; padding: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ðŸ‘¤ Menaxhimi i PÃ«rdoruesve</h1>

  <input id="name" placeholder="Emri" />
  <input id="pin" placeholder="PIN" />
  <input id="allowedFrom" placeholder="Nga ora (0â€“23)" type="number" min="0" max="23" />
  <input id="allowedTo" placeholder="Deri ora (1â€“24)" type="number" min="1" max="24" />
  <input id="adminPass" placeholder="FjalÃ«kalimi admin" type="password" />

  <div class="schedule-container">
    <h3>Orari specifik:</h3>
    <div id="scheduleItems">
      <!-- Oraret specifike do tÃ« shtohen kÃ«tu -->
    </div>
    <button class="add-btn" onclick="addScheduleItem()">+ Shto Orar</button>
  </div>

  <button onclick="addUser()">Shto / PÃ«rditÃ«so</button>

  <div class="msg" id="msg"></div>

  <table id="userTable">
    <thead>
      <tr>
        <th>PIN</th>
        <th>Emri</th>
        <th>Orari</th>
        <th>Orari specifik</th>
        <th>Veprim</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    let currentUserSchedule = [];

    async function fetchUsers() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [name, user] of Object.entries(data)) {
          const tr = document.createElement("tr");

          const tdPin = document.createElement("td");
          tdPin.textContent = user.pin || "â€”";
          tr.appendChild(tdPin);

          const tdName = document.createElement("td");
          tdName.textContent = name;
          tr.appendChild(tdName);

          const tdTime = document.createElement("td");
          tdTime.textContent = `${user.allowedFrom || 0}:00 - ${user.allowedTo || 24}:00`;
          tr.appendChild(tdTime);

          const tdSchedule = document.createElement("td");
          if (user.schedule && user.schedule.length > 0) {
            tdSchedule.innerHTML = user.schedule.map(s => 
              `${s.date} ${s.from}:00-${s.to}:00`
            ).join("<br>");
          } else {
            tdSchedule.textContent = "â€”";
          }
          tr.appendChild(tdSchedule);

          const tdAction = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "Fshij";
          delBtn.onclick = () => deleteUser(name);
          tdAction.appendChild(delBtn);
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        }
      } catch (err) {
        showMsg("Gabim: " + err.message, "error");
      }
    }

    function addScheduleItem() {
      const container = document.getElementById("scheduleItems");
      const itemDiv = document.createElement("div");
      itemDiv.className = "schedule-item";
      
      const dateInput = document.createElement("input");
      dateInput.type = "text";
      dateInput.className = "date-picker";
      dateInput.placeholder = "Zgjidh datÃ«n";
      
      const fromInput = document.createElement("input");
      fromInput.type = "number";
      fromInput.className = "time-input";
      fromInput.placeholder = "Nga";
      fromInput.min = "0";
      fromInput.max = "23";
      
      const toInput = document.createElement("input");
      toInput.type = "number";
      toInput.className = "time-input";
      toInput.placeholder = "Deri";
      toInput.min = "1";
      toInput.max = "24";
      
      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.textContent = "âœ•";
      removeBtn.onclick = function() {
        container.removeChild(itemDiv);
      };
      
      itemDiv.appendChild(dateInput);
      itemDiv.appendChild(document.createTextNode("Nga:"));
      itemDiv.appendChild(fromInput);
      itemDiv.appendChild(document.createTextNode("Deri:"));
      itemDiv.appendChild(toInput);
      itemDiv.appendChild(removeBtn);
      
      container.appendChild(itemDiv);
      
      flatpickr(dateInput, {
        dateFormat: "Y-m-d",
        minDate: "today"
      });
    }

    function getScheduleData() {
      const items = [];
      const scheduleItems = document.querySelectorAll(".schedule-item");
      
      scheduleItems.forEach(item => {
        const date = item.querySelector(".date-picker").value;
        const from = parseInt(item.querySelector(".time-input:nth-of-type(1)").value);
        const to = parseInt(item.querySelector(".time-input:nth-of-type(2)").value);
        
        if (date && !isNaN(from) && !isNaN(to)) {
          items.push({
            date,
            from,
            to
          });
        }
      });
      
      return items;
    }

    async function addUser() {
      const name = document.getElementById("name").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const from = parseInt(document.getElementById("allowedFrom").value || "0", 10);
      const to = parseInt(document.getElementById("allowedTo").value || "24", 10);
      const adminPass = document.getElementById("adminPass").value;
      const schedule = getScheduleData();

      if (!name || !pin || !adminPass) {
        return showMsg("Ju lutem plotÃ«soni tÃ« gjitha fushat", "error");
      }

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            pin,
            allowedFrom: from,
            allowedTo: to,
            schedule,
            adminPass
          })
        });

        const text = await res.text();
        showMsg(text, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim nÃ« rrjet: " + err.message, "error");
      }
    }

    async function deleteUser(name) {
      const adminPass = prompt("FjalÃ«kalimi admin pÃ«r fshirje:");
      if (!adminPass) return;

      try {
        const res = await fetch(apiUrl, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, adminPass })
        });
        const text = await res.text();
        showMsg(text, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim nÃ« rrjet: " + err.message, "error");
      }
    }

    function showMsg(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `msg ${type}`;
    }

    fetchUsers();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menaxho Përdoruesit dhe PIN-et</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #4a90e2, #145374);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    h1 {
      margin-bottom: 1rem;
      font-weight: 600;
      font-size: 1.8rem;
      letter-spacing: 1px;
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      padding: 2rem;
      width: 350px;
      max-width: 95vw;
      margin-bottom: 2rem;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 600;
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 0.6rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      outline: none;
      background: rgba(255,255,255,0.15);
      color: white;
      text-align: center;
      transition: background 0.3s ease;
    }
    input[type="text"]:focus, input[type="password"]:focus {
      background: rgba(255,255,255,0.3);
      box-shadow: 0 0 8px #77b6ea;
    }

    button {
      width: 100%;
      padding: 0.8rem;
      background: #28a745;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 1rem;
    }
    button:hover {
      background: #218838;
    }

    .user-list {
      max-height: 250px;
      overflow-y: auto;
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .user-name {
      font-weight: 600;
      flex: 1;
    }

    .user-pin {
      font-family: monospace;
      margin: 0 1rem;
      flex: 1;
      text-align: center;
    }

    .btn-delete {
      background: #dc3545;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .btn-delete:hover {
      background: #a71d2a;
    }

    #msg {
      min-height: 1.5em;
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 600;
    }
    .success { color: #a8ff9e; }
    .error { color: #ff6b6b; }
    .warning { color: #ffcc00; }

  </style>
</head>
<body>

  <h1>Menaxho Përdoruesit dhe PIN-et</h1>

  <div class="container">
    <label for="adminPass">Fjalëkalimi Admin:</label>
    <input id="adminPass" type="password" placeholder="Fut fjalëkalimin e administratorit" autocomplete="off" />

    <label for="name">Emri:</label>
    <input id="name" type="text" placeholder="Fut emrin e përdoruesit" autocomplete="off" />

    <label for="pin">PIN:</label>
    <input id="pin" type="text" maxlength="4" placeholder="Fut PIN-in" autocomplete="off" />

    <button id="btnAddUser">Shto / Ndrysho Përdorues</button>
    <div id="msg"></div>
  </div>

  <div class="container">
    <h2>Lista e përdoruesve:</h2>
    <div class="user-list" id="userList"></div>
  </div>

  <script>
    const API_URL = "https://porta.armnis76.workers.dev"; // Ndrysho me url të Worker-it tënd

    const adminPassInput = document.getElementById("adminPass");
    const nameInput = document.getElementById("name");
    const pinInput = document.getElementById("pin");
    const msgDiv = document.getElementById("msg");
    const userListDiv = document.getElementById("userList");
    const btnAddUser = document.getElementById("btnAddUser");

    async function fetchUsers() {
      try {
        const res = await fetch(API_URL, { method: "GET" });
        if (!res.ok) throw new Error("Gabim në marrjen e listës");
        const data = await res.json();
        renderUsers(data);
      } catch (err) {
        msgDiv.textContent = err.message;
        msgDiv.className = "error";
      }
    }

    function renderUsers(users) {
      userListDiv.innerHTML = "";
      if (Object.keys(users).length === 0) {
        userListDiv.textContent = "Nuk ka përdorues të regjistruar.";
        return;
      }
      for (const [pin, info] of Object.entries(users)) {
        const div = document.createElement("div");
        div.className = "user-item";

        const nameSpan = document.createElement("span");
        nameSpan.className = "user-name";
        nameSpan.textContent = info.name;

        const pinSpan = document.createElement("span");
        pinSpan.className = "user-pin";
        pinSpan.textContent = pin;

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-delete";
        btnDelete.textContent = "Fshi";
        btnDelete.onclick = () => deleteUser(pin);

        div.appendChild(nameSpan);
        div.appendChild(pinSpan);
        div.appendChild(btnDelete);

        userListDiv.appendChild(div);
      }
    }

    async function deleteUser(pin) {
      if (!confirm(`A je i sigurt që dëshiron të fshish PIN-in ${pin}?`)) return;
      const adminPass = adminPassInput.value.trim();
      if (!adminPass) {
        alert("Futni fjalëkalimin admin për fshirje.");
        return;
      }

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pin, delete: true, adminPass })
        });
        const text = await res.text();
        msgDiv.textContent = text;
        msgDiv.className = res.ok ? "success" : "error";
        if (res.ok) fetchUsers();
      } catch (err) {
        msgDiv.textContent = "Gabim në rrjet.";
        msgDiv.className = "error";
      }
    }

    btnAddUser.onclick = async () => {
      const adminPass = adminPassInput.value.trim();
      const name = nameInput.value.trim();
      const pin = pinInput.value.trim();

      if (!adminPass || !name || !pin) {
        msgDiv.textContent = "Ju lutem plotësoni të gjitha fushat.";
        msgDiv.className = "warning";
        return;
      }

      // Shto ose ndrysho user
      try {
        // Fillimisht dërgo me add:true, update:false
        let res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ add: true, adminPass, name, pin, update: false })
        });
        let text = await res.text();

        if (res.status === 409 && text.includes("Përdoruesi ekziston")) {
          // Nëse përdoruesi ekziston, pyet nëse doni ndryshim PIN
          if (confirm(`${text}\nDëshiron të ndryshosh PIN-in për këtë përdorues?`)) {
            res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ add: true, adminPass, name, pin, update: true })
            });
            text = await res.text();
            msgDiv.textContent = text;
            msgDiv.className = res.ok ? "success" : "error";
            if (res.ok) fetchUsers();
            return;
          } else {
            msgDiv.textContent = "Shtoimi u anulua.";
            msgDiv.className = "warning";
            return;
          }
        }

        msgDiv.textContent = text;
        msgDiv.className = res.ok ? "success" : "error";
        if (res.ok) {
          // Pas suksesi, pastro fushat dhe rifresko listën
          nameInput.value = "";
          pinInput.value = "";
          fetchUsers();
        }
      } catch (err) {
        msgDiv.textContent = "Gabim në rrjet.";
        msgDiv.className = "error";
      }
    };

    // Load lista kur hapet faqja
    fetchUsers();

  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Menaxhimi i Përdoruesve</title>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; background: white; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    input, button { padding: 5px; margin: 5px 0; }
    .form { margin-bottom: 2em; background: #fff; padding: 1em; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>📋 Menaxhimi i Përdoruesve</h1>

  <div class="form">
    <h2>➕ Shto ose Përditëso Përdorues</h2>
    <label>Emri: <input id="name" /></label><br />
    <label>PIN: <input id="pin" /></label><br />
    <label>Që nga (data & ora): <input id="from" type="datetime-local" /></label><br />
    <label>Deri më (data & ora): <input id="to" type="datetime-local" /></label><br />
    <label>Fjalëkalimi Admin: <input id="adminPass" type="password" /></label><br />
    <button onclick="save()">💾 Ruaj</button>
  </div>

  <table id="userTable">
    <thead>
      <tr>
        <th>Emri</th>
        <th>PIN</th>
        <th>Që nga</th>
        <th>Deri më</th>
        <th>Fshi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "/"; // përshtate nëse përdor rrugë tjetër
    const adminPass = document.getElementById("adminPass");

    async function fetchUsers() {
      const res = await fetch(API_URL);
      const data = await res.json();
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";

      Object.entries(data).forEach(([key, user]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.pin}</td>
          <td>${user.allowedFromDateTime || ''}</td>
          <td>${user.allowedToDateTime || ''}</td>
          <td><button onclick="deleteUser('${user.name}')">🗑️</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    async function save() {
      const name = document.getElementById("name").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const from = document.getElementById("from").value;
      const to = document.getElementById("to").value;

      if (!name || !pin || !adminPass.value) {
        alert("❗ Plotësoni të gjitha fushat.");
        return;
      }

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name,
          pin,
          adminPass: adminPass.value,
          allowedFromDateTime: from || null,
          allowedToDateTime: to || null
        })
      });

      const result = await res.json();
      alert(result.message || result.error);
      fetchUsers();
    }

    async function deleteUser(name) {
      if (!confirm(`🗑️ Fshini përdoruesin: ${name}?`)) return;

      const res = await fetch(API_URL, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, adminPass: adminPass.value })
      });

      const result = await res.json();
      alert(result.message || result.error);
      fetchUsers();
    }

    fetchUsers();
  </script>
</body>
</html>

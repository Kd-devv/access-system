<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Sistemi i Kontrollit të Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
    .tab { padding: 10px 20px; cursor: pointer; background: #f5f5f5; border: 1px solid #ddd; margin-right: 5px; border-radius: 5px 5px 0 0; }
    .tab.active { background: #fff; border-bottom: 1px solid #fff; margin-bottom: -1px; font-weight: bold; }
    .tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background-color: #f5f5f5; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    input, select { padding: 8px; margin: 5px; width: 200px; }
    .time-slot { display: flex; align-items: center; margin-bottom: 10px; }
    .time-slot input { width: 180px; margin: 0 10px; }
    .remove-btn { background-color: #ff6b6b; color: white; border: none; padding: 5px 10px; }
    .add-btn { background-color: #4CAF50; color: white; border: none; padding: 8px 16px; }
    #password-protection { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    #password-form { background: white; padding: 30px; border-radius: 8px; text-align: center; }
    #session-warning { position: fixed; bottom: 20px; right: 20px; background: #ff9800; color: white; padding: 15px; border-radius: 5px; display: none; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje në Sistem</h2>
      <input type="password" id="access-password" placeholder="Fjalëkalimi" autofocus>
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error" class="error" style="margin-top: 10px; display: none;"></div>
    </div>
  </div>

  <div id="session-warning">
    Session juaj do të skadojë në <span id="countdown">30:00</span>. Klikoni kudo për të vazhduar.
  </div>

  <div class="protected-content" style="display: none;">
    <h1>Sistemi i Kontrollit të Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Përdoruesit</div>
      <div class="tab" onclick="switchTab('logs')">Logjet</div>
    </div>
    
    <div id="users-tab" class="tab-content active">
      <div>
        <h2>Menaxho Përdorues</h2>
        <input id="name" placeholder="Emri">
        <input id="pin" placeholder="PIN" type="password">
        <input id="adminPass" placeholder="Fjalëkalimi Admin" type="password">
        
        <div id="timeSlotsContainer">
          <!-- Intervalet kohore do të shtohen këtu -->
        </div>
        <button class="add-btn" onclick="addTimeSlot()">+ Shto Interval Kohor</button>
        
        <button onclick="addUser()">Ruaj Përdorues</button>
        <div id="user-message" style="margin-top: 10px;"></div>
      </div>
      
      <table id="userTable">
        <thead>
          <tr>
            <th>Emri</th>
            <th>PIN</th>
            <th>Intervalet</th>
            <th>Veprim</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="logs-tab" class="tab-content">
      <div>
        <h2>Logjet e Aksesit</h2>
        <input id="filterInput" placeholder="Filtro sipas emrit, IP, statusit...">
        <button onclick="loadLogs()">🔁 Rifresko</button>
        <button onclick="exportAllXLSX()">📤 Eksporto të gjitha</button>
        <button onclick="exportFilteredXLSX()">📤 Eksporto të filtruarat</button>
        <button onclick="deleteFilteredLogs()" style="background-color: #f44336;">🗑️ Fshi të filtruarat</button>
        <button onclick="deleteAllLogs()" style="background-color: #f44336;">🗑️ Fshi të gjitha</button>
      </div>
      
      <table id="logTable">
        <thead>
          <tr>
            <th>Koha</th>
            <th>Emri</th>
            <th>PIN</th>
            <th>IP</th>
            <th>Statusi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minuta
    const WARNING_TIME = 5 * 60 * 1000; // 5 minuta paralajmërim
    
    let authToken = null;
    let allLogs = [];
    let inactivityTimer;
    let warningTimer;
    let countdownInterval;

    // Funksionet e autentikimit
    async function checkPassword() {
      const password = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");
      
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });
        
        if (response.ok) {
          const data = await response.json();
          authToken = data.token;
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          sessionStorage.setItem("authToken", authToken);
          fetchUsers();
          startSessionTimer();
        } else {
          const errorData = await response.json();
          errorElement.textContent = errorData.error || "Fjalëkalimi i gabuar";
          errorElement.style.display = "block";
        }
      } catch (err) {
        errorElement.textContent = "Gabim në lidhje me serverin";
        errorElement.style.display = "block";
      }
    }

    async function makeAuthRequest(url, options = {}) {
      const headers = options.headers || {};
      headers["Authorization"] = `Bearer ${authToken}`;
      return fetch(url, { ...options, headers });
    }

    // Funksione për përdoruesit
    function addTimeSlot() {
      const container = document.getElementById("timeSlotsContainer");
      const slotDiv = document.createElement("div");
      slotDiv.className = "time-slot";
      
      const startInput = document.createElement("input");
      startInput.placeholder = "Fillimi";
      
      const endInput = document.createElement("input");
      endInput.placeholder = "Mbarimi";
      
      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.textContent = "Fshi";
      removeBtn.onclick = () => container.removeChild(slotDiv);
      
      slotDiv.appendChild(startInput);
      slotDiv.appendChild(document.createTextNode(" deri "));
      slotDiv.appendChild(endInput);
      slotDiv.appendChild(removeBtn);
      
      container.appendChild(slotDiv);
      
      flatpickr(startInput, { enableTime: true, dateFormat: "Y-m-d H:i" });
      flatpickr(endInput, { enableTime: true, dateFormat: "Y-m-d H:i" });
    }

    function getTimeSlots() {
      const slots = [];
      const timeSlots = document.querySelectorAll(".time-slot");
      
      timeSlots.forEach(slot => {
        const inputs = slot.querySelectorAll("input");
        if (inputs.length === 2) {
          const start = inputs[0]._flatpickr?.selectedDates[0];
          const end = inputs[1]._flatpickr?.selectedDates[0];
          if (start && end) {
            slots.push({
              start: start.toISOString(),
              end: end.toISOString()
            });
          }
        }
      });
      
      return slots;
    }

    async function addUser() {
      const name = document.getElementById("name").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const adminPass = document.getElementById("adminPass").value;
      const timeSlots = getTimeSlots();
      
      if (!name || !pin || !adminPass) {
        showMessage("Plotëso të gjitha fushat e detyrueshme", "error");
        return;
      }

      try {
        const response = await makeAuthRequest(`${apiUrl}/users`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, pin, timeSlots, adminPass })
        });

        const result = await response.json();
        
        if (response.status === 403) {
          showMessage("Fjalëkalimi admin është i gabuar", "error");
          return;
        }

        showMessage(result.message || result.error, response.ok ? "success" : "error");
        if (response.ok) fetchUsers();
      } catch (err) {
        showMessage("Gabim në rrjet", "error");
      }
    }

    async function fetchUsers() {
      try {
        const response = await makeAuthRequest(`${apiUrl}/users`);
        
        if (response.status === 401) {
          sessionStorage.removeItem("authToken");
          window.location.reload();
          return;
        }

        const users = await response.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";
        
        for (const [name, data] of Object.entries(users)) {
          const row = document.createElement("tr");
          
          const timeSlotsText = data.timeSlots?.length > 0 
            ? `${data.timeSlots.length} intervale` 
            : "Pa kufizime";
          
          row.innerHTML = `
            <td>${name}</td>
            <td>${data.pin}</td>
            <td>${timeSlotsText}</td>
            <td><button onclick="deleteUser('${name}')">Fshi</button></td>
          `;
          
          tbody.appendChild(row);
        }
      } catch (err) {
        showMessage("Gabim në marrjen e përdoruesve", "error");
      }
    }

    async function deleteUser(name) {
      const adminPass = prompt("Fjalëkalimi admin për fshirje:");
      if (!adminPass) return;

      try {
        const response = await makeAuthRequest(`${apiUrl}/users`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, adminPass })
        });

        const result = await response.json();
        
        if (response.status === 403) {
          alert("Fjalëkalimi admin është i gabuar");
          return;
        }

        alert(result.message || result.error);
        if (response.ok) fetchUsers();
      } catch (err) {
        alert("Gabim në fshirjen e përdoruesit");
      }
    }

    // Funksione për logjet
    async function loadLogs() {
      try {
        const response = await makeAuthRequest(`${apiUrl}/logs");
        
        if (response.status === 401) {
          sessionStorage.removeItem("authToken");
          window.location.reload();
          return;
        }

        allLogs = await response.json();
        renderLogs();
      } catch (err) {
        showMessage("Gabim në marrjen e logjeve", "error");
      }
    }

    function renderLogs() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";

      for (const log of allLogs) {
        const logText = JSON.stringify(log).toLowerCase();
        if (filter && !logText.includes(filter)) {
          continue;
        }

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${new Date(log.time).toLocaleString()}</td>
          <td>${log.user || "-"}</td>
          <td>${log.pin || "-"}</td>
          <td>${log.ip || "-"}</td>
          <td>${log.status}</td>
        `;
        
        if (log.status === "success") {
          row.style.backgroundColor = "#e8f5e9";
        } else {
          row.style.backgroundColor = "#ffebee";
        }
        
        tbody.appendChild(row);
      }
    }

    async function deleteAllLogs() {
      if (!confirm("Jeni i sigurt që dëshironi të fshini të gjitha logjet?")) return;
      
      const adminPass = prompt("Fjalëkalimi admin:");
      if (!adminPass) return;

      try {
        const response = await makeAuthRequest(`${apiUrl}/logs`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ all: true, adminPass })
        });

        const result = await response.json();
        
        if (response.status === 403) {
          alert("Fjalëkalimi admin është i gabuar");
          return;
        }

        alert(result.message || result.error);
        if (response.ok) loadLogs();
      } catch (err) {
        alert("Gabim në fshirjen e logjeve");
      }
    }

    async function deleteFilteredLogs() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const logsToDelete = allLogs.filter(log => {
        const logText = JSON.stringify(log).toLowerCase();
        return filter === "" || logText.includes(filter);
      });

      if (logsToDelete.length === 0) {
        alert("Nuk ka logje për të fshirë sipas këtij filtri");
        return;
      }

      if (!confirm(`Jeni i sigurt që dëshironi të fshini ${logsToDelete.length} logje?`)) {
        return;
      }

      const adminPass = prompt("Fjalëkalimi admin për fshirje:");
      if (!adminPass) return;

      try {
        const response = await makeAuthRequest(`${apiUrl}/logs`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            logs: logsToDelete.map(log => ({ 
              time: log.time, 
              user: log.user 
            })), 
            adminPass 
          })
        });

        const result = await response.json();
        
        if (response.status === 403) {
          alert("Fjalëkalimi admin është i gabuar");
          return;
        }

        alert(result.message || result.error);
        if (response.ok) loadLogs();
      } catch (err) {
        alert("Gabim në fshirjen e logjeve");
      }
    }

    function exportAllXLSX() {
      const data = [
        ["Koha", "Emri", "PIN", "IP", "Statusi"],
        ...allLogs.map(log => [
          new Date(log.time).toLocaleString(),
          log.user || "-",
          log.pin || "-",
          log.ip || "-",
          log.status
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logjet");
      
      const date = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `Logjet_${date}.xlsx`);
    }

    function exportFilteredXLSX() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const filteredLogs = allLogs.filter(log => {
        const logText = JSON.stringify(log).toLowerCase();
        return filter === "" || logText.includes(filter);
      });

      if (filteredLogs.length === 0) {
        alert("Nuk ka logje për të eksportuar");
        return;
      }

      const data = [
        ["Koha", "Emri", "PIN", "IP", "Statusi"],
        ...filteredLogs.map(log => [
          new Date(log.time).toLocaleString(),
          log.user || "-",
          log.pin || "-",
          log.ip || "-",
          log.status
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logjet e Filtruara");
      
      const date = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `Logjet_e_Filtruara_${date}.xlsx`);
    }

    // Funksione ndihmëse
    function showMessage(message, type) {
      const element = document.getElementById("user-message");
      element.textContent = message;
      element.className = type;
    }

    function switchTab(tabName) {
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
      
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add("active");
      document.getElementById(`${tabName}-tab`).classList.add("active");
      
      if (tabName === "users") fetchUsers();
      else if (tabName === "logs") loadLogs();
    }

    function startSessionTimer() {
      clearTimeout(inactivityTimer);
      clearTimeout(warningTimer);
      clearInterval(countdownInterval);
      
      document.getElementById("session-warning").style.display = "none";
      
      inactivityTimer = setTimeout(() => {
        sessionStorage.removeItem("authToken");
        alert("Session ka skaduar për shkak të inaktivitetit");
        window.location.reload();
      }, SESSION_TIMEOUT);

      warningTimer = setTimeout(() => {
        const warningElement = document.getElementById("session-warning");
        warningElement.style.display = "block";
        
        let secondsLeft = WARNING_TIME / 1000;
        document.getElementById("countdown").textContent = 
          `${Math.floor(secondsLeft / 60)}:${(secondsLeft % 60).toString().padStart(2, '0')}`;
        
        countdownInterval = setInterval(() => {
          secondsLeft--;
          document.getElementById("countdown").textContent = 
            `${Math.floor(secondsLeft / 60)}:${(secondsLeft % 60).toString().padStart(2, '0')}`;
        }, 1000);
      }, SESSION_TIMEOUT - WARNING_TIME);
    }

    function resetSessionTimer() {
      startSessionTimer();
    }

    // Inicializimi
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("access-password").addEventListener("keypress", (e) => {
        if (e.key === "Enter") checkPassword();
      });
      
      document.getElementById("filterInput").addEventListener("input", renderLogs);
      
      // Aktivizo reset timer për çdo aktivitet
      document.addEventListener("mousemove", resetSessionTimer);
      document.addEventListener("keypress", resetSessionTimer);
      document.addEventListener("click", resetSessionTimer);
      
      // Kontrollo nëse ekziston token i ruajtur
      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        authToken = savedToken;
        document.getElementById("password-protection").style.display = "none";
        document.querySelector(".protected-content").style.display = "block";
        fetchUsers();
        startSessionTimer();
      }
    });
  </script>
</body>
</html>

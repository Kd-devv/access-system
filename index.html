<!DOCTYPE html>
<html lang="sq">
<head>
  <!-- Head content remains the same -->
</head>
<body>
  <!-- HTML content remains the same -->

  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    let allLogs = [];
    let authToken = null;
    
    async function checkPassword() {
      const enteredPassword = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");
      
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: enteredPassword })
        });
        
        if (!response.ok) {
          throw new Error("Gabim në autentifikim");
        }
        
        const data = await response.json();
        
        if (data.token) {
          authToken = data.token;
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          sessionStorage.setItem("authToken", data.token);
          await fetchUsers();
        } else {
          throw new Error("Nuk u mor token");
        }
      } catch (err) {
        errorElement.textContent = "Fjalëkalimi i gabuar ose gabim në server";
        errorElement.style.display = "block";
        document.getElementById("access-password").value = "";
        document.getElementById("access-password").focus();
      }
    }
    
    window.onload = async function() {
      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        try {
          const testResponse = await fetch(apiUrl, {
            headers: { "Authorization": `Bearer ${savedToken}` }
          });
          
          if (testResponse.ok) {
            authToken = savedToken;
            document.getElementById("password-protection").style.display = "none";
            document.querySelector(".protected-content").style.display = "block";
            await fetchUsers();
            return;
          }
        } catch (err) {
          console.error("Token verification failed:", err);
        }
      }
      
      document.getElementById("access-password").focus();
    };

    async function makeAuthRequest(url, options = {}) {
      const headers = {
        ...(options.headers || {}),
        "Authorization": `Bearer ${authToken}`
      };
      
      try {
        const response = await fetch(url, { ...options, headers });
        
        if (response.status === 401) {
          sessionStorage.removeItem("authToken");
          window.location.reload();
          return null;
        }
        
        return response;
      } catch (err) {
        console.error("Gabim në kërkesë:", err);
        throw err;
      }
    }
    
    // Other functions remain the same, but ensure they use makeAuthRequest properly
    async function fetchUsers() {
      try {
        const res = await makeAuthRequest(apiUrl);
        if (!res) return;
        
        const data = await res.json();
        console.log("Të dhënat e përdoruesve:", data);
        
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [name, user] of Object.entries(data)) {
          const tr = document.createElement("tr");

          // Add cells for name, pin, time slots, and action
          // ... (rest of the function remains the same)
        }
      } catch (err) {
        console.error("Gabim në fetchUsers:", err);
        showMsg("Gabim gjatë ngarkimit të përdoruesve: " + err.message, "error");
      }
    }

    // Rest of your JavaScript remains the same
  </script>
</body>
</html>

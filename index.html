<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Sistemi i Kontrollit tÃ« Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    
    /* Password protection */
    #password-protection {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #password-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    
    /* Session timeout warning */
    #session-timeout-warning {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff9800;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    
    /* Keep all your existing styles... */
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ccc; }
    .tab { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; }
    .tab.active { background: white; border-bottom: 1px solid white; margin-bottom: -1px; font-weight: bold; }
    /* ... plus all other existing styles */
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje nÃ« Sistem</h2>
      <p>Ju lutem shkruani fjalÃ«kalimin pÃ«r tÃ« hyrÃ«:</p>
      <input type="password" id="access-password" placeholder="FjalÃ«kalimi" autofocus />
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error" style="color:red;margin-top:10px;display:none;"></div>
    </div>
  </div>
  
  <!-- Session Timeout Warning -->
  <div id="session-timeout-warning">
    Sesioni do tÃ« skadojÃ« nÃ« <span id="countdown">5:00</span> 
    <button onclick="resetSession()" style="margin-left:10px;background:#4CAF50;color:white;border:none;padding:2px 8px;border-radius:3px;">Vazhdo</button>
  </div>

  <!-- Protected Content -->
  <div class="protected-content" style="display:none;">
    <div style="position:absolute;top:20px;right:20px;">
      <button onclick="logout()" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:4px;">Dil</button>
    </div>
    
    <h1>ðŸšª Sistemi i Kontrollit tÃ« Aksesit</h1>
    
    <!-- Keep all your existing tabs and content exactly as-is -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Menaxhimi i PÃ«rdoruesve</div>
      <div class="tab" onclick="switchTab('logs')">Logjet e Aksesit</div>
    </div>
    
    <div id="users-tab" class="tab-content active">
      <!-- Your existing user management content -->
    </div>
    
    <div id="logs-tab" class="tab-content">
      <!-- Your existing logs content -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    let authToken = null;
    let idleTimer;
    let countdownInterval;
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
    const WARNING_TIME = 5 * 60 * 1000; // 5 minute warning

    // ==================== SESSION MANAGEMENT ====================
    function setupActivityListeners() {
      ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
        document.addEventListener(event, resetIdleTimer);
      });
    }

    function resetIdleTimer() {
      clearTimeout(idleTimer);
      clearInterval(countdownInterval);
      document.getElementById('session-timeout-warning').style.display = 'none';
      
      idleTimer = setTimeout(logout, SESSION_TIMEOUT);
      setTimeout(showTimeoutWarning, SESSION_TIMEOUT - WARNING_TIME);
      
      // Refresh server-side session if we're logged in
      if (authToken) {
        fetch(`${apiUrl}/heartbeat`, {
          headers: { "Authorization": `Bearer ${authToken}` }
        }).catch(() => {});
      }
    }

    function showTimeoutWarning() {
      const warningDiv = document.getElementById('session-timeout-warning');
      warningDiv.style.display = 'block';
      
      let secondsLeft = WARNING_TIME / 1000;
      const countdownEl = document.getElementById('countdown');
      
      countdownInterval = setInterval(() => {
        secondsLeft--;
        const mins = Math.floor(secondsLeft / 60);
        const secs = secondsLeft % 60;
        countdownEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        
        if (secondsLeft <= 0) {
          clearInterval(countdownInterval);
        }
      }, 1000);
    }

    function resetSession() {
      resetIdleTimer();
    }

    async function logout() {
      if (authToken) {
        try {
          await fetch(`${apiUrl}/logout`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${authToken}` }
          });
        } catch (e) {
          console.error("Logout error:", e);
        }
      }
      sessionStorage.removeItem("authToken");
      window.location.reload();
    }

    // ==================== AUTHENTICATION ====================
    async function checkPassword() {
      const password = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");
      
      if (!password) {
        errorElement.textContent = "Ju lutem shkruani fjalÃ«kalimin";
        errorElement.style.display = "block";
        return;
      }

      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          authToken = data.token;
          sessionStorage.setItem("authToken", authToken);
          
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          
          setupActivityListeners();
          resetIdleTimer();
          fetchUsers();
        } else {
          errorElement.textContent = data.error || "FjalÃ«kalimi i gabuar";
          errorElement.style.display = "block";
        }
      } catch (err) {
        errorElement.textContent = "Gabim nÃ« rrjet: " + err.message;
        errorElement.style.display = "block";
      }
    }

    // ==================== INITIALIZATION ====================
    window.onload = async function() {
      document.getElementById("access-password").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkPassword();
      });

      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        try {
          const response = await fetch(`${apiUrl}/validate`, {
            headers: { "Authorization": `Bearer ${savedToken}` }
          });
          
          if (response.ok) {
            authToken = savedToken;
            document.getElementById("password-protection").style.display = "none";
            document.querySelector(".protected-content").style.display = "block";
            setupActivityListeners();
            resetIdleTimer();
            fetchUsers();
          } else {
            sessionStorage.removeItem("authToken");
          }
        } catch (err) {
          console.error("Session validation failed:", err);
        }
      }
    };

    // ==================== KEEP ALL YOUR EXISTING FUNCTIONS ====================
    // Keep all your existing:
    // - switchTab()
    // - fetchUsers()
    // - addTimeSlot()
    // - getTimeSlots()
    // - addUser()
    // - deleteUser()
    // - loadLogs()
    // - export functions
    // - etc.
    // They don't need any changes!

    // Just make sure all your fetch requests include the auth header:
    // headers: { 
    //   "Content-Type": "application/json",
    //   "Authorization": `Bearer ${authToken}`
    // }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit tÃ« Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Stilet e mÃ«parshme mbeten tÃ« njÃ«jta */
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje nÃ« Sistem</h2>
      <p>Ju lutem shkruani fjalÃ«kalimin pÃ«r tÃ« hyrÃ«:</p>
      <input type="password" id="access-password" placeholder="FjalÃ«kalimi" autofocus />
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error">FjalÃ«kalimi i gabuar, provoni pÃ«rsÃ«ri!</div>
    </div>
  </div>

  <!-- Session Timeout Warning -->
  <div id="session-warning">
    Session juaj do tÃ« skadojÃ« nÃ« <span id="countdown">30:00</span>. Klikoni kudo pÃ«r tÃ« vazhduar.
  </div>
  
  <!-- Protected Content -->
  <div class="protected-content">
    <h1>ğŸšª Sistemi i Kontrollit tÃ« Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Menaxhimi i PÃ«rdoruesve</div>
      <div class="tab" onclick="switchTab('logs')">Logjet e Aksesit</div>
    </div>
    
    <!-- User Management Tab -->
    <div id="users-tab" class="tab-content active">
      <!-- PÃ«rmbajtja e mÃ«parshme mbetet e njÃ«jtÃ« -->
    </div>
    
    <!-- Access Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="controls">
        <input type="text" id="filterInput" placeholder="Filtro sipas emrit, IP, statusit..." />
        <button onclick="loadLogs()">ğŸ” Rifresko</button>
        <button onclick="exportAllXLSX()">ğŸ“¤ Eksporto tÃ« gjitha (Excel)</button>
        <button onclick="exportFilteredXLSX()">ğŸ“¤ Eksporto tÃ« filtruarat (Excel)</button>
        <button onclick="deleteFilteredLogs()" style="background-color: #f44336;">ğŸ—‘ï¸ Fshij tÃ« filtruarat</button>
        <button onclick="deleteAllLogs()" style="background-color: #f44336;">ğŸ—‘ï¸ Fshij tÃ« gjitha</button>
      </div>

      <table id="logTable">
        <thead>
          <tr>
            <th>Koha</th>
            <th>Emri</th>
            <th>PIN i pÃ«rdorur</th>
            <th>IP</th>
            <th>Statusi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Konfigurimi
    const apiUrl = "https://porta.armnis76.workers.dev";
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minuta
    const WARNING_TIME = 5 * 60 * 1000; // ParalajmÃ«rim 5 minuta para skadimit
    
    let allLogs = [];
    let authToken = null;
    let inactivityTimer;
    let warningTimer;
    let countdownInterval;

    // Funksione pÃ«r fshirjen e logjeve (tÃ« pÃ«rditÃ«suara)
    async function deleteFilteredLogs() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const logsToDelete = allLogs.filter(log => {
        const values = [log.user, log.pin, log.ip, log.status].map(v => (v || "").toLowerCase());
        return filter === "" || values.some(v => v.includes(filter));
      });

      if (logsToDelete.length === 0) {
        showMsg("Nuk ka logje pÃ«r tÃ« fshirÃ« sipas kÃ«tij filtri", "error");
        return;
      }

      if (!confirm(`Jeni i sigurt qÃ« dÃ«shironi tÃ« fshini ${logsToDelete.length} logje?`)) {
        return;
      }

      const adminPass = prompt("FjalÃ«kalimi admin pÃ«r fshirje:");
      if (!adminPass) return;

      try {
        const res = await makeAuthRequest(`${apiUrl}/logs`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            logs: logsToDelete,
            adminPass
          })
        });

        const data = await res.json();
        
        if (res.status === 403) {
          showMsg("FjalÃ«kalimi admin Ã«shtÃ« i gabuar", "error");
          return;
        }

        if (!res.ok) {
          showMsg(data.error || "Gabim nÃ« fshirjen e logjeve", "error");
          return;
        }

        showMsg(data.message, "success");
        loadLogs();
      } catch (err) {
        showMsg("Gabim nÃ« fshirjen e logjeve: " + err.message, "error");
      }
    }

    async function deleteAllLogs() {
      if (!confirm("Jeni i sigurt qÃ« dÃ«shironi tÃ« fshini TÃ‹ GJITHA logjet?")) {
        return;
      }

      const adminPass = prompt("FjalÃ«kalimi admin pÃ«r fshirje:");
      if (!adminPass) return;

      try {
        const res = await makeAuthRequest(`${apiUrl}/logs`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            all: true,
            adminPass
          })
        });

        const data = await res.json();
        
        if (res.status === 403) {
          showMsg("FjalÃ«kalimi admin Ã«shtÃ« i gabuar", "error");
          return;
        }

        if (!res.ok) {
          showMsg(data.error || "Gabim nÃ« fshirjen e logjeve", "error");
          return;
        }

        showMsg(data.message, "success");
        loadLogs();
      } catch (err) {
        showMsg("Gabim nÃ« fshirjen e logjeve: " + err.message, "error");
      }
    }

    // Pjesa tjetÃ«r e kodit mbetet e njÃ«jtÃ« si mÃ« parÃ«
    // ...
  </script>
</body>
</html>

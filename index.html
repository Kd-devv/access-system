<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit të Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Stilet e mëparshme mbeten të njëjta */
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje në Sistem</h2>
      <p>Ju lutem shkruani fjalëkalimin për të hyrë:</p>
      <input type="password" id="access-password" placeholder="Fjalëkalimi" autofocus />
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error">Fjalëkalimi i gabuar, provoni përsëri!</div>
    </div>
  </div>

  <!-- Session Timeout Warning -->
  <div id="session-warning">
    Session juaj do të skadojë në <span id="countdown">30:00</span>. Klikoni kudo për të vazhduar.
  </div>
  
  <!-- Protected Content -->
  <div class="protected-content">
    <h1>🚪 Sistemi i Kontrollit të Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Menaxhimi i Përdoruesve</div>
      <div class="tab" onclick="switchTab('logs')">Logjet e Aksesit</div>
    </div>
    
    <!-- User Management Tab -->
    <div id="users-tab" class="tab-content active">
      <!-- Përmbajtja e mëparshme mbetet e njëjtë -->
    </div>
    
    <!-- Access Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="controls">
        <input type="text" id="filterInput" placeholder="Filtro sipas emrit, IP, statusit..." />
        <button onclick="loadLogs()">🔁 Rifresko</button>
        <button onclick="exportAllXLSX()">📤 Eksporto të gjitha (Excel)</button>
        <button onclick="exportFilteredXLSX()">📤 Eksporto të filtruarat (Excel)</button>
        <button onclick="deleteFilteredLogs()" style="background-color: #f44336;">🗑️ Fshij të filtruarat</button>
        <button onclick="deleteAllLogs()" style="background-color: #f44336;">🗑️ Fshij të gjitha</button>
      </div>

      <table id="logTable">
        <thead>
          <tr>
            <th>Koha</th>
            <th>Emri</th>
            <th>PIN i përdorur</th>
            <th>IP</th>
            <th>Statusi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Konfigurimi
    const apiUrl = "https://porta.armnis76.workers.dev";
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minuta
    const WARNING_TIME = 5 * 60 * 1000; // Paralajmërim 5 minuta para skadimit
    
    let allLogs = [];
    let authToken = null;
    let inactivityTimer;
    let warningTimer;
    let countdownInterval;

    // Funksione për fshirjen e logjeve (të përditësuara)
    async function deleteFilteredLogs() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const logsToDelete = allLogs.filter(log => {
        const values = [log.user, log.pin, log.ip, log.status].map(v => (v || "").toLowerCase());
        return filter === "" || values.some(v => v.includes(filter));
      });

      if (logsToDelete.length === 0) {
        showMsg("Nuk ka logje për të fshirë sipas këtij filtri", "error");
        return;
      }

      if (!confirm(`Jeni i sigurt që dëshironi të fshini ${logsToDelete.length} logje?`)) {
        return;
      }

      const adminPass = prompt("Fjalëkalimi admin për fshirje:");
      if (!adminPass) return;

      try {
        const res = await makeAuthRequest(`${apiUrl}/logs`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            logs: logsToDelete,
            adminPass
          })
        });

        const data = await res.json();
        
        if (res.status === 403) {
          showMsg("Fjalëkalimi admin është i gabuar", "error");
          return;
        }

        if (!res.ok) {
          showMsg(data.error || "Gabim në fshirjen e logjeve", "error");
          return;
        }

        showMsg(data.message, "success");
        loadLogs();
      } catch (err) {
        showMsg("Gabim në fshirjen e logjeve: " + err.message, "error");
      }
    }

    async function deleteAllLogs() {
      if (!confirm("Jeni i sigurt që dëshironi të fshini TË GJITHA logjet?")) {
        return;
      }

      const adminPass = prompt("Fjalëkalimi admin për fshirje:");
      if (!adminPass) return;

      try {
        const res = await makeAuthRequest(`${apiUrl}/logs`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            all: true,
            adminPass
          })
        });

        const data = await res.json();
        
        if (res.status === 403) {
          showMsg("Fjalëkalimi admin është i gabuar", "error");
          return;
        }

        if (!res.ok) {
          showMsg(data.error || "Gabim në fshirjen e logjeve", "error");
          return;
        }

        showMsg(data.message, "success");
        loadLogs();
      } catch (err) {
        showMsg("Gabim në fshirjen e logjeve: " + err.message, "error");
      }
    }

    // Pjesa tjetër e kodit mbetet e njëjtë si më parë
    // ...
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8">
  <title>Sistemi i Kontrollit të Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    
    #password-protection {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #password-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #password-form h2 {
      margin-top: 0;
    }
    #password-form input {
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
      width: 200px;
    }
    #password-form button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    #password-error {
      color: red;
      margin-top: 10px;
      display: none;
    }
    
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ccc; }
    .tab { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; }
    .tab.active { background: white; border-bottom: 1px solid white; margin-bottom: -1px; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    input, button, select { padding: 8px; margin: 4px 0; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    
    .time-slots { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .time-slot { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .time-slot input { width: 180px; }
    .remove-btn { background: #ff6b6b; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .add-btn { background: #4CAF50; color: white; border: none; padding: 8px; cursor: pointer; margin-top: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px; }
    .log-success { background: #d4edda; }
    .log-error { background: #f8d7da; }
    
    .protected-content { display: none; }
  </style>
</head>
<body>
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje në Sistem</h2>
      <p>Ju lutem shkruani fjalëkalimin për të hyrë:</p>
      <input type="password" id="access-password" placeholder="Fjalëkalimi">
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error">Fjalëkalimi i gabuar, provoni përsëri!</div>
    </div>
  </div>
  
  <div class="protected-content">
    <h1>🚪 Sistemi i Kontrollit të Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Menaxhimi i Përdoruesve</div>
      <div class="tab" onclick="switchTab('logs')">Logjet e Aksesit</div>
    </div>
    
    <div id="users-tab" class="tab-content active">
      <div class="form-group">
        <label for="name">Emri i përdoruesit:</label>
        <input id="name" placeholder="Emri">
      </div>

      <div class="form-group">
        <label for="pin">PIN:</label>
        <input id="pin" placeholder="PIN" type="password">
      </div>

      <div class="form-group">
        <label for="adminPass">Fjalëkalimi Admin:</label>
        <input id="adminPass" placeholder="Fjalëkalimi admin" type="password">
      </div>

      <div class="time-slots">
        <h3>Intervalet kohore të lejuara:</h3>
        <div id="timeSlotsContainer"></div>
        <button class="add-btn" onclick="addTimeSlot()">+ Shto Interval Kohor</button>
      </div>

      <button onclick="addUser()" style="margin-top: 20px; padding: 10px;">Shto / Përditëso Përdorues</button>

      <div class="msg" id="msg"></div>

      <table id="userTable">
        <thead>
          <tr>
            <th>Emri</th>
            <th>PIN</th>
            <th>Intervalet Kohore</th>
            <th>Veprim</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="logs-tab" class="tab-content">
      <div class="controls">
        <input type="text" id="filterInput" placeholder="Filtro sipas emrit, IP, statusit...">
        <button onclick="loadLogs()">🔁 Rifresko</button>
        <button onclick="exportAllXLSX()">📤 Eksporto të gjitha (Excel)</button>
        <button onclick="exportFilteredXLSX()">📤 Eksporto të filtruarat (Excel)</button>
      </div>

      <table id="logTable">
        <thead>
          <tr>
            <th>Koha</th>
            <th>Emri</th>
            <th>PIN i përdorur</th>
            <th>IP</th>
            <th>Statusi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    let authToken = null;
    let allLogs = [];
    
    // Password functions
    async function checkPassword() {
      const password = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");
      
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password }),
          mode: 'cors'
        });
        
        if (response.ok) {
          const data = await response.json();
          authToken = data.token;
          sessionStorage.setItem("authToken", authToken);
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          fetchUsers();
        } else {
          errorElement.style.display = "block";
          document.getElementById("access-password").value = "";
        }
      } catch (err) {
        errorElement.textContent = "Gabim në rrjet: " + err.message;
        errorElement.style.display = "block";
      }
    }

    // Initialize on load
    window.onload = async function() {
      document.getElementById("access-password").addEventListener("keyup", function(e) {
        if (e.key === "Enter") checkPassword();
      });
      
      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        try {
          const test = await fetch(apiUrl, {
            headers: { "Authorization": `Bearer ${savedToken}` },
            mode: 'cors'
          });
          
          if (test.ok) {
            authToken = savedToken;
            document.getElementById("password-protection").style.display = "none";
            document.querySelector(".protected-content").style.display = "block";
            fetchUsers();
          }
        } catch {
          sessionStorage.removeItem("authToken");
        }
      }
    };

    // Auth request helper
    async function makeAuthRequest(url, options = {}) {
      const headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${authToken}`,
        ...(options.headers || {})
      };
      
      try {
        const response = await fetch(url, {
          ...options,
          headers,
          mode: 'cors'
        });

        if (response.status === 401) {
          sessionStorage.removeItem("authToken");
          window.location.reload();
          return null;
        }

        return response;
      } catch (error) {
        console.error("Network error:", error);
        showMsg("Gabim në rrjet", "error");
        throw error;
      }
    }

    // User management functions
    function initDateTimePicker(element) {
      return flatpickr(element, {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true
      });
    }

    function addTimeSlot() {
      const container = document.getElementById("timeSlotsContainer");
      const slotDiv = document.createElement("div");
      slotDiv.className = "time-slot";
      
      const startInput = document.createElement("input");
      startInput.placeholder = "Data dhe ora e fillimit";
      
      const endInput = document.createElement("input");
      endInput.placeholder = "Data dhe ora e mbarimit";
      
      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.textContent = "Fshij";
      removeBtn.onclick = () => container.removeChild(slotDiv);
      
      slotDiv.appendChild(startInput);
      slotDiv.appendChild(document.createTextNode("deri"));
      slotDiv.appendChild(endInput);
      slotDiv.appendChild(removeBtn);
      
      container.appendChild(slotDiv);
      initDateTimePicker(startInput);
      initDateTimePicker(endInput);
    }

    function getTimeSlots() {
      const slots = [];
      document.querySelectorAll(".time-slot").forEach(slot => {
        const inputs = slot.querySelectorAll("input");
        if (inputs[0]._flatpickr && inputs[1]._flatpickr) {
          const start = inputs[0]._flatpickr.selectedDates[0];
          const end = inputs[1]._flatpickr.selectedDates[0];
          if (start && end) {
            slots.push({
              start: start.toISOString(),
              end: end.toISOString()
            });
          }
        }
      });
      return slots;
    }

    async function addUser() {
      const name = document.getElementById("name").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const adminPass = document.getElementById("adminPass").value;
      const timeSlots = getTimeSlots();

      if (!name || !pin || !adminPass) {
        return showMsg("Ju lutem plotësoni të gjitha fushat", "error");
      }

      try {
        const res = await makeAuthRequest(apiUrl, {
          method: "POST",
          body: JSON.stringify({ name, pin, adminPass, timeSlots })
        });
        
        if (!res) return;
        
        const text = await res.text();
        showMsg(text, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim: " + err.message, "error");
      }
    }

    async function deleteUser(name) {
      if (!confirm(`Jeni i sigurt që dëshironi të fshini ${name}?`)) return;
      
      const adminPass = prompt("Fjalëkalimi admin:");
      if (!adminPass) return;

      try {
        const res = await makeAuthRequest(apiUrl, {
          method: "DELETE",
          body: JSON.stringify({ name, adminPass })
        });
        
        if (!res) return;
        
        const text = await res.text();
        showMsg(text, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim: " + err.message, "error");
      }
    }

    async function fetchUsers() {
      try {
        const res = await makeAuthRequest(`${apiUrl}/users`);
        if (!res) return;
        
        const data = await res.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [name, user] of Object.entries(data)) {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${name}</td>
            <td>${user.pin || "—"}</td>
            <td>
              ${user.timeSlots?.length > 0 ? 
                user.timeSlots.map(s => `
                  ${new Date(s.start).toLocaleString()} - 
                  ${new Date(s.end).toLocaleString()}
                `).join("<br>") : "—"}
            </td>
            <td><button onclick="deleteUser('${name}')">Fshij</button></td>
          `;
          
          tbody.appendChild(tr);
        }
      } catch (err) {
        showMsg("Gabim në ngarkim: " + err.message, "error");
      }
    }

    // Logs functions
    async function loadLogs() {
      try {
        const res = await makeAuthRequest(`${apiUrl}/logs`);
        if (!res) return;
        
        const data = await res.json();
        allLogs = Object.values(data)
          .sort((a, b) => new Date(b.time) - new Date(a.time));
        renderLogs();
      } catch (err) {
        showMsg("Gabim në ngarkim: " + err.message, "error");
      }
    }

    function renderLogs() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";

      allLogs
        .filter(log => !filter || 
          (log.user || "").toLowerCase().includes(filter) ||
          (log.pin || "").toLowerCase().includes(filter) ||
          (log.ip || "").toLowerCase().includes(filter) ||
          (log.status || "").toLowerCase().includes(filter))
        .forEach(log => {
          const tr = document.createElement("tr");
          tr.className = log.status === "success" ? "log-success" : "log-error";
          tr.innerHTML = `
            <td>${new Date(log.time).toLocaleString()}</td>
            <td>${log.user || "—"}</td>
            <td>${log.pin || "—"}</td>
            <td>${log.ip || "—"}</td>
            <td>${log.status}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    function exportAllXLSX() {
      exportToExcel(allLogs, "Logjet_e_plota");
    }

    function exportFilteredXLSX() {
      const filter = document.getElementById("filterInput").value.toLowerCase();
      const filtered = allLogs.filter(log => 
        !filter || (log.user || "").toLowerCase().includes(filter)
      );
      exportToExcel(filtered, "Logjet_e_filtruara");
    }

    function exportToExcel(data, fileName) {
      try {
        const wsData = [
          ["Koha", "Emri", "PIN", "IP", "Statusi"],
          ...data.map(log => [
            new Date(log.time).toLocaleString(),
            log.user || "—",
            log.pin || "—",
            log.ip || "—",
            log.status
          ])
        ];
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Logjet");
        
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `${fileName}_${dateStr}.xlsx`);
        showMsg("Eksportimi u krye me sukses", "success");
      } catch (err) {
        showMsg("Gabim në eksportim: " + err.message, "error");
      }
    }

    // Helper functions
    function showMsg(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `msg ${type}`;
    }

    function switchTab(tabName) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      
      document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add("active");
      document.getElementById(`${tabName}-tab`).classList.add("active");
      
      if (tabName === "logs") loadLogs();
      else if (tabName === "users") fetchUsers();
    }

    // Initialize logs filter
    document.getElementById("filterInput").addEventListener("input", renderLogs);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menaxhimi i Userave me PIN</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #4a90e2, #145374);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      color: #fff;
    }

    h1 {
      margin: 1.5rem 0 1rem;
      font-weight: 600;
      font-size: 1.8rem;
      letter-spacing: 1px;
      text-align: center;
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 2rem 3rem;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      width: 360px;
      max-width: 90vw;
      margin-bottom: 2rem;
    }

    input[type="password"],
    input[type="text"] {
      width: 100%;
      padding: 1rem;
      font-size: 1.25rem;
      border: none;
      border-radius: 10px;
      margin-bottom: 1rem;
      outline: none;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      text-align: center;
      transition: background 0.3s ease;
    }

    input[type="password"]:focus,
    input[type="text"]:focus {
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 8px #77b6ea;
    }

    button {
      width: 100%;
      padding: 1rem;
      background: #28a745;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 0.5rem;
    }

    button:hover {
      background: #218838;
    }

    #userList {
      max-height: 250px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
      color: #fff;
      font-size: 1rem;
    }

    .userEntry {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.6rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 0.3rem;
      align-items: center;
    }

    .userEntry:last-child {
      border-bottom: none;
    }

    .userInfo {
      flex-grow: 1;
    }

    .btnSmall {
      background: #dc3545;
      border-radius: 6px;
      padding: 0.3rem 0.6rem;
      font-size: 0.9rem;
      margin-left: 0.5rem;
      cursor: pointer;
      transition: background 0.3s ease;
      border: none;
      color: #fff;
    }

    .btnSmall:hover {
      background: #b02a37;
    }

    #msg {
      margin-top: 1rem;
      font-size: 1.15rem;
      min-height: 1.5em;
      user-select: none;
      text-align: center;
    }

    .success {
      color: #a8ff9e;
      font-weight: 600;
    }
    .warning {
      color: #ffcc00;
      font-weight: 600;
    }
    .error {
      color: #ff6b6b;
      font-weight: 700;
    }
  </style>
</head>
<body>

  <h1>Menaxho Userat me PIN</h1>

  <div class="container" id="formContainer">
    <input id="name" type="text" maxlength="30" placeholder="Emri i përdoruesit" autocomplete="off" />
    <input id="pin" type="password" maxlength="4" placeholder="PIN (4 shifra)" autocomplete="off" />
    <input id="adminPass" type="password" placeholder="Fjalëkalimi admin" autocomplete="off" />
    <button onclick="shtoUser()">Shto / Ndrysho User</button>
    <div id="msg"></div>
  </div>

  <div class="container" id="listContainer">
    <h2>Lista e Userave</h2>
    <div id="userList">Duke ngarkuar...</div>
  </div>

<script>
  const API_URL = "https://porta.armnis76.workers.dev";

  const msgDiv = document.getElementById("msg");
  const userListDiv = document.getElementById("userList");

  // Nxirr listen e userave nga worker
  async function fetchUsers() {
    msgDiv.textContent = "Duke ngarkuar userat...";
    msgDiv.className = "";

    try {
      const res = await fetch(API_URL + "?list=1");
      if (!res.ok) throw new Error("Gabim në marrjen e listës.");

      const data = await res.json();

      if (!Array.isArray(data)) throw new Error("Të dhëna të pasakta nga serveri.");

      if (data.length === 0) {
        userListDiv.textContent = "Nuk ka usera të regjistruar.";
        return;
      }

      userListDiv.innerHTML = "";

      data.forEach(user => {
        const div = document.createElement("div");
        div.className = "userEntry";

        const userInfo = document.createElement("div");
        userInfo.className = "userInfo";
        userInfo.textContent = `${user.name} — PIN: ${user.pin}`;

        const delBtn = document.createElement("button");
        delBtn.className = "btnSmall";
        delBtn.textContent = "Fshij";
        delBtn.onclick = () => fshijUser(user.pin, user.name);

        div.appendChild(userInfo);
        div.appendChild(delBtn);
        userListDiv.appendChild(div);
      });

      msgDiv.textContent = "";
      msgDiv.className = "";

    } catch (err) {
      msgDiv.textContent = "❌ " + err.message;
      msgDiv.className = "error";
    }
  }

  // Shto ose ndrysho user
  async function shtoUser() {
    const name = document.getElementById("name").value.trim();
    const pin = document.getElementById("pin").value.trim();
    const adminPass = document.getElementById("adminPass").value;

    if (!name) {
      alert("Shkruaj emrin e përdoruesit.");
      return;
    }
    if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) {
      alert("Futni një PIN 4-shifror të vlefshëm.");
      return;
    }
    if (!adminPass) {
      alert("Futni fjalëkalimin admin.");
      return;
    }

    const body = { name, pin, adminPass };

    msgDiv.textContent = "Po përpunoj...";
    msgDiv.className = "";

    try {
      let res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      let data = await res.json();

      if (res.status === 409 && data.error && data.error.includes("Përdoruesi ekziston")) {
        if (confirm(data.error + "\nDëshiron të ndryshosh PIN-in për këtë përdorues?")) {
          body.update = true;
          res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          data = await res.json();
          alert(data.success || data.error || "Pa mesazh");
          if (res.ok) {
            fetchUsers();
            clearForm();
          }
          return;
        } else {
          alert("Shtoimi u anulua.");
          msgDiv.textContent = "";
          return;
        }
      }

      alert(data.success || data.error || "Pa mesazh");
      if (res.ok) {
        fetchUsers();
        clearForm();
      } else {
        msgDiv.textContent = data.error || "Gabim i panjohur";
        msgDiv.className = "error";
      }
    } catch (err) {
      msgDiv.textContent = "❌ " + err.message;
      msgDiv.className = "error";
    }
  }

  // Fshij user sipas PIN
  async function fshijUser(pin, name) {
    if (!confirm(`A dëshironi të fshini përdoruesin "${name}" me PIN: ${pin}?`)) {
      return;
    }

    const adminPass = prompt("Futni fjalëkalimin admin për fshirje:");
    if (!adminPass) {
      alert("Fshirja u anulua: Nuk u fut fjalëkalimi admin.");
      return;
    }

    msgDiv.textContent = "Po fshihet...";
    msgDiv.className = "";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin, adminPass, delete: true })
      });

      const data = await res.json();

      alert(data.success || data.error || "Pa mesazh");

      if (res.ok) {
        fetchUsers();
        msgDiv.textContent = "";
      } else {
        msgDiv.textContent = data.error || "Gabim i panjohur";
        msgDiv.className = "error";
      }
    } catch (err) {
      msgDiv.textContent = "❌ " + err.message;
      msgDiv.className = "error";
    }
  }

  function clearForm() {
    document.getElementById("name").value = "";
    document.getElementById("pin").value = "";
    document.getElementById("adminPass").value = "";
  }

  // Ngarko fillimisht listen
  fetchUsers();
</script>

</body>
</html>

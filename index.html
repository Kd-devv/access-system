const ADMIN_PASSWORD = "porta123";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "Content-Type",
  "Access-Control-Allow-Methods": "GET, POST, DELETE, OPTIONS",
  "Content-Type": "application/json"
};

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), { status, headers: corsHeaders });
}

addEventListener("fetch", event => {
  event.respondWith(handleRequest(event.request));
});

async function logAccess(name, status, request) {
  const now = new Date().toISOString();
  const ip = request.headers.get("cf-connecting-ip") || "n/a";
  const logKey = `log-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
  const logValue = {
    user: name,
    time: now,
    ip,
    status
  };
  await PIN_DB.put(logKey, JSON.stringify(logValue));
}

async function handleRequest(request) {
  const { method } = request;
  const url = new URL(request.url);

  if (method === "OPTIONS") {
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  // === SHFAQ LOGE ===
  if (url.pathname === "/logs" && method === "GET") {
    const logs = {};
    const entries = await PIN_DB.list({ prefix: "log-", limit: 1000 });
    for (const entry of entries.keys) {
      const val = await PIN_DB.get(entry.name);
      if (val) logs[entry.name] = JSON.parse(val);
    }
    return jsonResponse(logs);
  }

  if (method === "GET") {
    // SHFAQ PÃ‹RDORUESIT
    const list = {};
    const entries = await PIN_DB.list({ limit: 1000 });
    for (const key of entries.keys) {
      if (key.name.startsWith("log-")) continue;
      const val = await PIN_DB.get(key.name);
      list[key.name] = JSON.parse(val);
    }
    return jsonResponse(list);
  }

  if (method === "POST") {
    let body;
    try {
      body = await request.json();
    } catch {
      return jsonResponse({ error: "âš ï¸ JSON i pavlefshÃ«m." }, 400);
    }

    const { name, pin, adminPass, allowedFromDateTime, allowedToDateTime } = body;

    // === SHTO/UPDATE NGA ADMINI ===
    if (adminPass !== undefined) {
      if (adminPass !== ADMIN_PASSWORD) {
        return jsonResponse({ error: "ğŸš« FjalÃ«kalimi admin i pasaktÃ«." }, 403);
      }
      if (!name || !pin) {
        return jsonResponse({ error: "â— Emri dhe PIN kÃ«rkohen." }, 400);
      }

      const existing = await PIN_DB.get(name);
      let oldData = existing ? JSON.parse(existing) : {};

      const userData = {
        name,
        pin,
        allowedFromDateTime: allowedFromDateTime || oldData.allowedFromDateTime || null,
        allowedToDateTime: allowedToDateTime || oldData.allowedToDateTime || null
      };

      await PIN_DB.put(name, JSON.stringify(userData));
      return jsonResponse({ message: `âœ… PÃ«rdoruesi u ruajt pÃ«r ${name}` });
    }

    // === KÃ‹RKESÃ‹ AKSESI ===
    if (!name || !pin) {
      return jsonResponse({ error: "â— Emri dhe PIN kÃ«rkohen." }, 400);
    }

    const data = await PIN_DB.get(name);
    if (!data) {
      await logAccess(name, "user_not_found", request);
      return jsonResponse({ error: "âŒ PÃ«rdoruesi nuk ekziston." }, 404);
    }

    const user = JSON.parse(data);
    if (user.pin !== pin) {
      await logAccess(name, "wrong_pin", request);
      return jsonResponse({ error: "ğŸ”‘ PIN i gabuar." }, 403);
    }

    const now = new Date();
    const from = user.allowedFromDateTime ? new Date(user.allowedFromDateTime) : new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
    const to = user.allowedToDateTime ? new Date(user.allowedToDateTime) : new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

    if (now < from || now >= to) {
      await logAccess(name, "out_of_hours", request);
      return jsonResponse({
        error: `â° JashtÃ« orarit tÃ« lejuar (${from.toLocaleString()} â€“ ${to.toLocaleString()}).`
      }, 403);
    }

    // Komanda pÃ«r IFTTT
    const iftttUrl = "https://maker.ifttt.com/trigger/Porta/with/key/b5U1h_z5XAuGBFHczy0Mvr";
    try {
      const r = await fetch(iftttUrl, { method: "POST" });
      if (r.ok) {
        await logAccess(name, "success", request);
        return jsonResponse({ message: `ğŸ”“ Porta u hap pÃ«r ${user.name}.` });
      } else {
        await logAccess(name, "ifttt_failed", request);
        return jsonResponse({ error: "â— DÃ«shtoi lidhja me IFTTT." }, 500);
      }
    } catch (err) {
      await logAccess(name, "network_error", request);
      return jsonResponse({ error: "ğŸŒ Gabim rrjeti: " + err.message }, 500);
    }
  }

  if (method === "DELETE") {
    let body;
    try {
      body = await request.json();
    } catch {
      return jsonResponse({ error: "âš ï¸ JSON i pavlefshÃ«m." }, 400);
    }

    const { name, adminPass } = body;

    if (adminPass !== ADMIN_PASSWORD) {
      return jsonResponse({ error: "ğŸš« FjalÃ«kalimi admin i gabuar." }, 403);
    }

    if (!name) {
      return jsonResponse({ error: "âš ï¸ Emri mungon pÃ«r fshirje." }, 400);
    }

    const existing = await PIN_DB.get(name);
    if (!existing) {
      return jsonResponse({ error: "âŒ Ky pÃ«rdorues nuk ekziston." }, 404);
    }

    await PIN_DB.delete(name);
    return jsonResponse({ message: `ğŸ—‘ï¸ PÃ«rdoruesi ${name} u fshi me sukses.` });
  }

  return jsonResponse({ error: "âŒ MetodÃ« e pambÃ«shtetur." }, 405);
}

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Menaxhimi i PÃ«rdoruesve</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    input, button { padding: 8px; margin: 4px 0; width: 100%; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>ðŸ‘¤ Menaxhimi i PÃ«rdoruesve</h1>

  <input id="name" placeholder="Emri" />
  <input id="pin" placeholder="PIN" />
  <label>Orari i lejuar:</label>
  <input id="allowedFromDateTime" type="datetime-local" />
  <input id="allowedToDateTime" type="datetime-local" />
  <input id="adminPass" placeholder="FjalÃ«kalimi admin" type="password" />
  <button onclick="addUser()">Shto / PÃ«rditÃ«so</button>

  <div class="msg" id="msg"></div>

  <table id="userTable">
    <thead>
      <tr>
        <th>PIN</th>
        <th>Emri</th>
        <th>Orari (data & orÃ«)</th>
        <th>Veprim</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";

    async function fetchUsers() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [name, user] of Object.entries(data)) {
          const tr = document.createElement("tr");

          const tdPin = document.createElement("td");
          tdPin.textContent = user.pin || "â€”";
          tr.appendChild(tdPin);

          const tdName = document.createElement("td");
          tdName.textContent = name;
          tr.appendChild(tdName);

          const tdTime = document.createElement("td");
          const from = user.allowedFromDateTime ? new Date(user.allowedFromDateTime).toLocaleString() : "Pa kufizim";
          const to = user.allowedToDateTime ? new Date(user.allowedToDateTime).toLocaleString() : "Pa kufizim";
          tdTime.textContent = `${from} - ${to}`;
          tr.appendChild(tdTime);

          const tdAction = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "Fshij";
          delBtn.onclick = () => deleteUser(name);
          tdAction.appendChild(delBtn);
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        }
      } catch (err) {
        showMsg("Gabim: " + err.message, "error");
      }
    }

    async function addUser() {
      const name = document.getElementById("name").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const allowedFromDateTime = document.getElementById("allowedFromDateTime").value;
      const allowedToDateTime = document.getElementById("allowedToDateTime").value;
      const adminPass = document.getElementById("adminPass").value;

      if (!name || !pin || !adminPass) {
        return showMsg("Ju lutem plotÃ«soni tÃ« gjitha fushat", "error");
      }

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            pin,
            allowedFromDateTime: allowedFromDateTime || null,
            allowedToDateTime: allowedToDateTime || null,
            adminPass,
            add: true
          })
        });

        const json = await res.json();
        showMsg(json.message || json.error, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim nÃ« rrjet: " + err.message, "error");
      }
    }

    async function deleteUser(name) {
      const adminPass = prompt("FjalÃ«kalimi admin pÃ«r fshirje:");
      if (!adminPass) return;

      try {
        const res = await fetch(apiUrl, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, adminPass })
        });
        const json = await res.json();
        showMsg(json.message || json.error, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim nÃ« rrjet: " + err.message, "error");
      }
    }

    function showMsg(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `msg ${type}`;
    }

    fetchUsers();
  </script>
</body>
</html>

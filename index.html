<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit t√´ Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    
    /* Password protection styles */
    #password-protection {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #password-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #password-form h2 {
      margin-top: 0;
    }
    #password-form input {
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
      width: 200px;
    }
    #password-form button {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    #password-error {
      color: red;
      margin-top: 10px;
      display: none;
    }
    
    /* Tab styles */
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ccc; }
    .tab { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; }
    .tab.active { background: white; border-bottom: 1px solid white; margin-bottom: -1px; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Common styles */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    input, button, select { padding: 8px; margin: 4px 0; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    
    /* User management specific styles */
    .time-slots { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .time-slot { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .time-slot input { width: 180px; }
    .remove-btn { background: #ff6b6b; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .add-btn { background: #4CAF50; color: white; border: none; padding: 8px; cursor: pointer; margin-top: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    
    /* Logs specific styles */
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px; }
    .log-success { background: #d4edda; }
    .log-error { background: #f8d7da; }
    
    /* Hidden content when not authenticated */
    .protected-content { display: none; }
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje n√´ Sistem</h2>
      <p>Ju lutem shkruani fjal√´kalimin p√´r t√´ hyr√´:</p>
      <input type="password" id="access-password" placeholder="Fjal√´kalimi" />
      <button id="login-btn">Hyr</button>
      <div id="password-error">Fjal√´kalimi i gabuar, provoni p√´rs√´ri!</div>
    </div>
  </div>
  
  <!-- Protected Content (hidden until authenticated) -->
  <div class="protected-content">
    <h1>üö™ Sistemi i Kontrollit t√´ Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="users">Menaxhimi i P√´rdoruesve</div>
      <div class="tab" data-tab="logs">Logjet e Aksesit</div>
    </div>
    
    <!-- User Management Tab -->
    <div id="users-tab" class="tab-content active">
      <div class="form-group">
        <label for="name">Emri i p√´rdoruesit:</label>
        <input id="name" placeholder="Emri" />
      </div>

      <div class="form-group">
        <label for="pin">PIN:</label>
        <input id="pin" placeholder="PIN" type="password" />
      </div>

      <div class="form-group">
        <label for="adminPass">Fjal√´kalimi Admin:</label>
        <input id="adminPass" placeholder="Fjal√´kalimi admin" type="password" />
      </div>

      <div class="time-slots">
        <h3>Intervalet kohore t√´ lejuara:</h3>
        <div id="timeSlotsContainer">
          <!-- Intervalet kohore do t√´ shtohen k√´tu -->
        </div>
        <button class="add-btn" id="add-time-slot">+ Shto Interval Kohor</button>
      </div>

      <button id="add-user-btn" style="margin-top: 20px; padding: 10px;">Shto / P√´rdit√´so P√´rdorues</button>

      <div class="msg" id="msg"></div>

      <table id="userTable">
        <thead>
          <tr>
            <th>Emri</th>
            <th>PIN</th>
            <th>Intervalet Kohore</th>
            <th>Veprim</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Access Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="controls">
        <input type="text" id="filterInput" placeholder="Filtro sipas emrit, IP, statusit..." />
        <button id="refresh-logs">üîÅ Rifresko</button>
        <button id="export-excel">üì§ Eksporto Excel</button>
        <button id="delete-filtered" style="background-color: #f44336;">üóëÔ∏è Fshij t√´ filtruarat</button>
        <button id="delete-all" style="background-color: #f44336;">üóëÔ∏è Fshij t√´ gjitha</button>
      </div>

      <table id="logTable">
        <thead>
          <tr>
            <th>Koha</th>
            <th>Emri</th>
            <th>PIN i p√´rdorur</th>
            <th>IP</th>
            <th>Statusi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Initialize variables
    const apiUrl = "https://porta.armnis76.workers.dev";
    let allLogs = [];
    let authToken = null;
    
    // DOM Elements
    const loginBtn = document.getElementById('login-btn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const addTimeSlotBtn = document.getElementById('add-time-slot');
    const addUserBtn = document.getElementById('add-user-btn');
    const refreshLogsBtn = document.getElementById('refresh-logs');
    const exportExcelBtn = document.getElementById('export-excel');
    const deleteFilteredBtn = document.getElementById('delete-filtered');
    const deleteAllBtn = document.getElementById('delete-all');
    const filterInput = document.getElementById('filterInput');

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Check if already authenticated
      checkAuthentication();
      
      // Initialize event listeners
      initEventListeners();
      
      // Initialize flatpickr if needed
      if (document.querySelector('.time-slot input')) {
        initDateTimePickers();
      }
    });

    function initEventListeners() {
      loginBtn.addEventListener('click', checkPassword);
      
      // Tab switching
      tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });
      
      // User management
      addTimeSlotBtn.addEventListener('click', addTimeSlot);
      addUserBtn.addEventListener('click', addUser);
      
      // Logs management
      refreshLogsBtn.addEventListener('click', loadLogs);
      exportExcelBtn.addEventListener('click', exportXLSX);
      deleteFilteredBtn.addEventListener('click', deleteFilteredLogs);
      deleteAllBtn.addEventListener('click', deleteAllLogs);
      filterInput.addEventListener('input', renderLogs);
      
      // Allow Enter key for password submission
      document.getElementById('access-password').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') checkPassword();
      });
    }

    // Authentication functions
    async function checkAuthentication() {
      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        try {
          const testResponse = await fetch(apiUrl, {
            headers: { "Authorization": `Bearer ${savedToken}` }
          });
          
          if (testResponse.ok) {
            authToken = savedToken;
            document.getElementById("password-protection").style.display = "none";
            document.querySelector(".protected-content").style.display = "block";
            fetchUsers();
          }
        } catch (err) {
          console.error("Token verification failed:", err);
        }
      }
    }

    async function checkPassword() {
      const enteredPassword = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");
      
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: enteredPassword })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          authToken = data.token;
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          fetchUsers();
          sessionStorage.setItem("authToken", data.token);
        } else {
          errorElement.style.display = "block";
          document.getElementById("access-password").value = "";
          document.getElementById("access-password").focus();
        }
      } catch (err) {
        errorElement.textContent = "Gabim n√´ rrjet: " + err.message;
        errorElement.style.display = "block";
      }
    }

    // Rest of your functions (addTimeSlot, getTimeSlots, addUser, deleteUser, etc.)
    // ... [Include all other functions from your original code here]
    // Make sure to keep all the existing functionality
    
    // Excel Export function
    function exportXLSX() {
      try {
        // Prepare the data
        const data = [
          ["Koha", "Emri", "PIN i p√´rdorur", "IP", "Statusi"],
          ...allLogs.map(log => [
            new Date(log.time).toLocaleString(),
            log.user || "-",
            log.pin || "-",
            log.ip || "-",
            log.status || "-"
          ])
        ];

        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Set column widths
        ws['!cols'] = [
          { wch: 25 }, { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 25 }
        ];

        // Create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Logjet e Aksesit");

        // Generate file
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        XLSX.writeFile(wb, `Logjet_Aksesit_${dateStr}.xlsx`);

        showMsg("Skeda Excel u eksportua me sukses!", "success");
      } catch (err) {
        showMsg("Gabim gjat√´ eksportimit: " + err.message, "error");
      }
    }

    // Initialize the application
    function init() {
      checkAuthentication();
      if (authToken) {
        fetchUsers();
      }
    }

    // Start the application
    init();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit tÃ« Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* [Keep all your existing CSS styles exactly as they are] */
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje nÃ« Sistem</h2>
      <p>Ju lutem shkruani fjalÃ«kalimin pÃ«r tÃ« hyrÃ«:</p>
      <input type="password" id="access-password" placeholder="FjalÃ«kalimi" autofocus />
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error">FjalÃ«kalimi i gabuar, provoni pÃ«rsÃ«ri!</div>
    </div>
  </div>
  
  <!-- Protected Content -->
  <div class="protected-content">
    <div style="position:absolute;top:20px;right:20px;">
      <button onclick="logout()" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:4px;">Dil</button>
    </div>
    
    <h1>ðŸšª Sistemi i Kontrollit tÃ« Aksesit</h1>
    
    <!-- [Keep all your existing HTML content exactly as it is] -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    let authToken = null;
    let idleTimer;
    let countdownInterval;
    const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes
    const WARNING_TIME = 5 * 60 * 1000; // 5 minute warning

    // ==================== SESSION MANAGEMENT ====================
    function setupActivityListeners() {
      ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
        document.addEventListener(event, resetIdleTimer);
      });
    }

    function resetIdleTimer() {
      clearTimeout(idleTimer);
      clearInterval(countdownInterval);
      
      idleTimer = setTimeout(logout, SESSION_TIMEOUT);
      
      // Refresh server-side session if we're logged in
      if (authToken) {
        fetch(`${apiUrl}/heartbeat`, {
          headers: { "Authorization": `Bearer ${authToken}` }
        }).catch(() => {});
      }
    }

    function resetSession() {
      resetIdleTimer();
    }

    async function logout() {
      if (authToken) {
        try {
          await fetch(`${apiUrl}/logout`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${authToken}` }
          });
        } catch (e) {
          console.error("Logout error:", e);
        }
      }
      sessionStorage.removeItem("authToken");
      window.location.reload();
    }

    // ==================== AUTHENTICATION ====================
    async function checkPassword() {
      const password = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");
      
      if (!password) {
        errorElement.textContent = "Ju lutem shkruani fjalÃ«kalimin";
        errorElement.style.display = "block";
        return;
      }

      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          authToken = data.token;
          sessionStorage.setItem("authToken", authToken);
          
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          
          setupActivityListeners();
          resetIdleTimer();
          fetchUsers();
        } else {
          errorElement.textContent = data.error || "FjalÃ«kalimi i gabuar";
          errorElement.style.display = "block";
        }
      } catch (err) {
        errorElement.textContent = "Gabim nÃ« rrjet: " + err.message;
        errorElement.style.display = "block";
      }
    }

    // ==================== INITIALIZATION ====================
    window.onload = async function() {
      document.getElementById("access-password").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkPassword();
      });

      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        try {
          const response = await fetch(`${apiUrl}/users`, {
            headers: { "Authorization": `Bearer ${savedToken}` }
          });
          
          if (response.ok) {
            authToken = savedToken;
            document.getElementById("password-protection").style.display = "none";
            document.querySelector(".protected-content").style.display = "block";
            setupActivityListeners();
            resetIdleTimer();
            fetchUsers();
          } else {
            sessionStorage.removeItem("authToken");
          }
        } catch (err) {
          console.error("Session validation failed:", err);
        }
      }
    };

    // ==================== HELPER FUNCTION ====================
    async function makeAuthRequest(url, options = {}) {
      const headers = options.headers || {};
      headers["Authorization"] = `Bearer ${authToken}`;
      return fetch(url, { ...options, headers });
    }

    // [Keep all your existing functions exactly as they are]
    // - switchTab()
    // - fetchUsers()
    // - addTimeSlot()
    // - getTimeSlots()
    // - addUser()
    // - deleteUser()
    // - loadLogs()
    // - export functions
    // Just ensure they all use makeAuthRequest() for API calls
  </script>
</body>
</html>

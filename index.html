<!-- BEGIN index.html -->
<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Sistemi i Kontrollit tÃ« Aksesit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    /* ... (CSS unchanged for brevity, same as before) ... */
  </style>
</head>
<body>
  <!-- Password Protection Screen -->
  <div id="password-protection">
    <div id="password-form">
      <h2>Hyrje nÃ« Sistem</h2>
      <p>Ju lutem shkruani fjalÃ«kalimin pÃ«r tÃ« hyrÃ«:</p>
      <input type="password" id="access-password" placeholder="FjalÃ«kalimi" />
      <button onclick="checkPassword()">Hyr</button>
      <div id="password-error">FjalÃ«kalimi i gabuar, provoni pÃ«rsÃ«ri!</div>
    </div>
  </div>
  
  <!-- Protected Content -->
  <div class="protected-content">
    <h1>ðŸšª Sistemi i Kontrollit tÃ« Aksesit</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('users')">Menaxhimi i PÃ«rdoruesve</div>
      <div class="tab" onclick="switchTab('logs')">Logjet e Aksesit</div>
    </div>
    
    <!-- User Management Tab -->
    <div id="users-tab" class="tab-content active">
      <!-- ... (same input fields and buttons) ... -->
      <div class="msg" id="msg"></div>
      <table id="userTable">
        <thead>
          <tr>
            <th>Emri</th>
            <th>PIN</th>
            <th>Intervalet Kohore</th>
            <th>Veprim</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <!-- ... (log filters and table) ... -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";
    let allLogs = [];
    let authToken = null;

    async function checkPassword() {
      const enteredPassword = document.getElementById("access-password").value;
      const errorElement = document.getElementById("password-error");

      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: enteredPassword })
        });

        const data = await response.json();

        if (response.ok && data.token) {
          authToken = data.token;
          document.getElementById("password-protection").style.display = "none";
          document.querySelector(".protected-content").style.display = "block";
          fetchUsers();
          sessionStorage.setItem("authToken", data.token);
        } else {
          errorElement.style.display = "block";
          document.getElementById("access-password").value = "";
          document.getElementById("access-password").focus();
        }
      } catch (err) {
        errorElement.textContent = "Gabim nÃ« rrjet: " + err.message;
        errorElement.style.display = "block";
      }
    }

    window.onload = async function() {
      const savedToken = sessionStorage.getItem("authToken");
      if (savedToken) {
        try {
          const testResponse = await fetch(`${apiUrl}/users`, {
            headers: { "Authorization": `Bearer ${savedToken}` }
          });

          if (testResponse.ok) {
            authToken = savedToken;
            document.getElementById("password-protection").style.display = "none";
            document.querySelector(".protected-content").style.display = "block";
            fetchUsers();
            return;
          }
        } catch (err) {
          console.error("Token verification failed:", err);
        }
      }

      document.getElementById("access-password").focus();
    };

    async function makeAuthRequest(url, options = {}) {
      const headers = options.headers || {};
      headers["Authorization"] = `Bearer ${authToken}`;
      return fetch(url, { ...options, headers });
    }

    document.getElementById("access-password").addEventListener("keyup", function(event) {
      if (event.key === "Enter") {
        checkPassword();
      }
    });

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');

      if (tabName === 'users') fetchUsers();
      else if (tabName === 'logs') loadLogs();
    }

    // âœ… CHANGED: Now using /users instead of /
    async function fetchUsers() {
      try {
        const res = await makeAuthRequest(`${apiUrl}/users`);
        if (res.status === 401) {
          sessionStorage.removeItem("authToken");
          window.location.reload();
          return;
        }

        const data = await res.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [name, user] of Object.entries(data)) {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = name;
          tr.appendChild(tdName);

          const tdPin = document.createElement("td");
          tdPin.textContent = user.pin || "â€”";
          tr.appendChild(tdPin);

          const tdTimeSlots = document.createElement("td");
          if (user.timeSlots && user.timeSlots.length > 0) {
            const slotsList = document.createElement("div");
            user.timeSlots.forEach(slot => {
              const start = new Date(slot.start);
              const end = new Date(slot.end);
              const slotDiv = document.createElement("div");
              slotDiv.textContent = `${start.toLocaleString()} - ${end.toLocaleString()}`;
              slotsList.appendChild(slotDiv);
            });
            tdTimeSlots.appendChild(slotsList);
          } else {
            tdTimeSlots.textContent = "â€”";
          }
          tr.appendChild(tdTimeSlots);

          const tdAction = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "Fshij";
          delBtn.onclick = () => deleteUser(name);
          tdAction.appendChild(delBtn);
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        }
      } catch (err) {
        showMsg("Gabim gjatÃ« ngarkimit tÃ« pÃ«rdoruesve: " + err.message, "error");
      }
    }

    function showMsg(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `msg ${type}`;
    }

    // ... (rest of the functions like addUser, deleteUser, loadLogs etc remain unchanged) ...
  </script>
</body>
</html>
<!-- END index.html -->

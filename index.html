<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Kontroll Aksesi</title>
</head>
<body>
  <h2>Lista e Përdoruesve</h2>
  <table id="userTable" border="1">
    <thead>
      <tr><th>PIN</th><th>Emër</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiUrl = "https://porta.armnis76.workers.dev/users";

    async function makeAuthRequest(url, options = {}) {
      const authToken = sessionStorage.getItem("authToken");
      return fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
          "Authorization": authToken,
        },
      });
    }

    async function fetchUsers() {
      try {
        const authToken = sessionStorage.getItem("authToken");
        console.log("Auth token:", authToken);

        const res = await makeAuthRequest(apiUrl);
        console.log("Fetch users status:", res.status);

        if (res.status === 401) {
          sessionStorage.removeItem("authToken");
          window.location.reload();
          return;
        }

        const data = await res.json();
        console.log("Fetched users data:", data);

        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [pin, user] of Object.entries(data)) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${pin}</td><td>${user.name}</td>`;
          tbody.appendChild(tr);
        }
      } catch (err) {
        alert("Gabim gjatë ngarkimit të përdoruesve: " + err.message);
      }
    }

    // Testim PIN manual për shembull
    sessionStorage.setItem("authToken", "1234");
    fetchUsers();
  </script>
</body>
</html>

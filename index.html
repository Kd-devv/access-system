<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Menaxhimi i PÃ«rdoruesve</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    input, button, select { padding: 8px; margin: 4px 0; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .time-slots { margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .time-slot { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    .time-slot input { width: 180px; }
    .remove-btn { background: #ff6b6b; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .add-btn { background: #4CAF50; color: white; border: none; padding: 8px; cursor: pointer; margin-top: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸ‘¤ Menaxhimi i PÃ«rdoruesve</h1>

  <div class="form-group">
    <label for="name">Emri i pÃ«rdoruesit:</label>
    <input id="name" placeholder="Emri" />
  </div>

  <div class="form-group">
    <label for="pin">PIN:</label>
    <input id="pin" placeholder="PIN" type="password" />
  </div>

  <div class="form-group">
    <label for="adminPass">FjalÃ«kalimi Admin:</label>
    <input id="adminPass" placeholder="FjalÃ«kalimi admin" type="password" />
  </div>

  <div class="time-slots">
    <h3>Intervalet kohore tÃ« lejuara:</h3>
    <div id="timeSlotsContainer">
      <!-- Intervalet kohore do tÃ« shtohen kÃ«tu -->
    </div>
    <button class="add-btn" onclick="addTimeSlot()">+ Shto Interval Kohor</button>
  </div>

  <button onclick="addUser()" style="margin-top: 20px; padding: 10px;">Shto / PÃ«rditÃ«so PÃ«rdorues</button>

  <div class="msg" id="msg"></div>

  <table id="userTable">
    <thead>
      <tr>
        <th>Emri</th>
        <th>PIN</th>
        <th>Intervalet Kohore</th>
        <th>Veprim</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const apiUrl = "https://porta.armnis76.workers.dev";

    // Inicializo flatpickr pÃ«r zgjedhjen e datÃ«s dhe orÃ«s
    function initDateTimePicker(element) {
      return flatpickr(element, {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minDate: "today"
      });
    }

    // Shto njÃ« interval tÃ« ri kohor
    function addTimeSlot() {
      const container = document.getElementById("timeSlotsContainer");
      const slotDiv = document.createElement("div");
      slotDiv.className = "time-slot";
      
      // Fushat pÃ«r datÃ«n dhe orÃ«n e fillimit
      const startInput = document.createElement("input");
      startInput.placeholder = "Data dhe ora e fillimit";
      
      // Fushat pÃ«r datÃ«n dhe orÃ«n e mbarimit
      const endInput = document.createElement("input");
      endInput.placeholder = "Data dhe ora e mbarimit";
      
      // Butoni pÃ«r tÃ« fshirÃ« intervalin
      const removeBtn = document.createElement("button");
      removeBtn.className = "remove-btn";
      removeBtn.textContent = "Fshij";
      removeBtn.onclick = function() {
        container.removeChild(slotDiv);
      };
      
      slotDiv.appendChild(startInput);
      slotDiv.appendChild(document.createTextNode("deri"));
      slotDiv.appendChild(endInput);
      slotDiv.appendChild(removeBtn);
      
      container.appendChild(slotDiv);
      
      // Inicializo datetime pickers
      initDateTimePicker(startInput);
      initDateTimePicker(endInput);
    }

    // Merr tÃ« gjitha intervalet kohore nga forma
    function getTimeSlots() {
      const slots = [];
      const timeSlots = document.querySelectorAll(".time-slot");
      
      timeSlots.forEach(slot => {
        const startInput = slot.querySelector("input:nth-of-type(1)");
        const endInput = slot.querySelector("input:nth-of-type(2)");
        
        if (startInput._flatpickr && endInput._flatpickr) {
          const startDate = startInput._flatpickr.selectedDates[0];
          const endDate = endInput._flatpickr.selectedDates[0];
          
          if (startDate && endDate) {
            slots.push({
              start: startDate.toISOString(),
              end: endDate.toISOString()
            });
          }
        }
      });
      
      return slots;
    }

    // Shto ose pÃ«rditÃ«so njÃ« pÃ«rdorues
    async function addUser() {
      const name = document.getElementById("name").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const adminPass = document.getElementById("adminPass").value;
      const timeSlots = getTimeSlots();

      if (!name || !pin || !adminPass) {
        return showMsg("Ju lutem plotÃ«soni tÃ« gjitha fushat e detyrueshme", "error");
      }

      if (timeSlots.length === 0) {
        return showMsg("Ju lutem shtoni tÃ« paktÃ«n njÃ« interval kohor", "error");
      }

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            pin,
            timeSlots,
            adminPass
          })
        });

        const text = await res.text();
        showMsg(text, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim nÃ« rrjet: " + err.message, "error");
      }
    }

    // Fshi njÃ« pÃ«rdorues
    async function deleteUser(name) {
      const adminPass = prompt("FjalÃ«kalimi admin pÃ«r fshirje:");
      if (!adminPass) return;

      try {
        const res = await fetch(apiUrl, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, adminPass })
        });
        const text = await res.text();
        showMsg(text, res.ok ? "success" : "error");
        if (res.ok) fetchUsers();
      } catch (err) {
        showMsg("Gabim nÃ« rrjet: " + err.message, "error");
      }
    }

    // Shfaq mesazhin e statusit
    function showMsg(text, type) {
      const msg = document.getElementById("msg");
      msg.textContent = text;
      msg.className = `msg ${type}`;
    }

    // Shfaq tÃ« gjithÃ« pÃ«rdoruesit
    async function fetchUsers() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = "";

        for (const [name, user] of Object.entries(data)) {
          const tr = document.createElement("tr");

          // Emri
          const tdName = document.createElement("td");
          tdName.textContent = name;
          tr.appendChild(tdName);

          // PIN
          const tdPin = document.createElement("td");
          tdPin.textContent = user.pin || "â€”";
          tr.appendChild(tdPin);

          // Intervalet kohore
          const tdTimeSlots = document.createElement("td");
          if (user.timeSlots && user.timeSlots.length > 0) {
            const slotsList = document.createElement("div");
            user.timeSlots.forEach(slot => {
              const start = new Date(slot.start);
              const end = new Date(slot.end);
              const slotDiv = document.createElement("div");
              slotDiv.textContent = `${start.toLocaleString()} - ${end.toLocaleString()}`;
              slotsList.appendChild(slotDiv);
            });
            tdTimeSlots.appendChild(slotsList);
          } else {
            tdTimeSlots.textContent = "â€”";
          }
          tr.appendChild(tdTimeSlots);

          // Veprimet
          const tdAction = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "Fshij";
          delBtn.onclick = () => deleteUser(name);
          tdAction.appendChild(delBtn);
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        }
      } catch (err) {
        showMsg("Gabim gjatÃ« ngarkimit tÃ« pÃ«rdoruesve: " + err.message, "error");
      }
    }

    // Ngarko pÃ«rdoruesit kur faqja tÃ« hapet
    fetchUsers();
  </script>
</body>
</html>
